<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Model Test</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1e1e1e;
            color: white;
            font-family: Arial, sans-serif;
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 100;
            background: rgba(0,0,0,0.7);
            padding: 20px;
            border-radius: 5px;
        }
        button {
            display: block;
            margin: 10px 0;
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover {
            background: #1976D2;
        }
        #model-container {
            width: 100vw;
            height: 100vh;
        }
    </style>
</head>
<body>
    <div id="controls">
        <h3>3D Model Test</h3>
        <h4>Mounting</h4>
        <button onclick="testPlate()">Add Plate</button>
        <button onclick="testBox()">Add Box</button>
        <button onclick="testShelf()">Add Shelf</button>
        <button onclick="testDINRail()">Add DIN Rail</button>
        <h4>PLC Components</h4>
        <button onclick="testPLC()">Add CPU</button>
        <button onclick="testPowerSupply()">Add Power Supply</button>
        <h4>Field Devices</h4>
        <button onclick="testButton()">Add Button (Red)</button>
        <button onclick="testMotor()">Add Motor</button>
        <button onclick="testLED()">Add LED (Green)</button>
        <h4>Actions</h4>
        <button onclick="testExample()">Create Full Example</button>
        <button onclick="toggleGrid()">Toggle Grid</button>
        <button onclick="toggleAxes()">Toggle Axes</button>
        <button onclick="testTransform()">Test Transform Controls</button>
        <button onclick="clearScene()">Clear Scene</button>
        <h4>External Models</h4>
        <input type="file" id="modelFile" accept=".obj,.stl,.mtl" style="display:none">
        <button onclick="loadExternalModel()">Load CAD Model</button>
    </div>
    
    <div id="model-container"></div>
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    
    <!-- 3D Model System -->
    <script src="js/model/config.js"></script>
    <script src="js/shared/utils.js"></script>
    <script src="js/model/mounting.js"></script>
    <script src="js/model/components/plc.js"></script>
    <script src="js/model/components/wire.js"></script>
    <script src="js/model/components/button.js"></script>
    <script src="js/model/components/motor.js"></script>
    <script src="js/model/components/led.js"></script>
    <script src="js/model/scene.js"></script>
    
    <script>
        let modelScene;
        
        // Initialize scene
        window.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing 3D scene...');
            modelScene = new ModelScene('model-container');
            console.log('Scene initialized:', modelScene);
        });
        
        function testPlate() {
            if (!modelScene) return;
            modelScene.addMountingSurface('plate', {
                width: 600,
                length: 400,
                thickness: 2
            });
            console.log('Plate added');
        }
        
        function testBox() {
            if (!modelScene) return;
            modelScene.addMountingSurface('box', {
                width: 400,
                length: 600,
                height: 300,
                wallThickness: 2
            });
            console.log('Box added');
        }
        
        function testShelf() {
            if (!modelScene) return;
            modelScene.addMountingSurface('shelf', {
                wallWidth: 400,
                wallHeight: 300,
                shelfDepth: 200,
                thickness: 2
            });
            console.log('Shelf added');
        }
        
        function testDINRail() {
            if (!modelScene) return;
            const rail = modelScene.addMountingSurface('din-rail', {
                length: 500
            });
            if (rail) {
                rail.position = { x: 0, y: 50, z: 0 };
                const railMesh = modelScene.scene.children.find(
                    child => child.userData.mounting === rail
                );
                if (railMesh) {
                    railMesh.position.set(0, 50, 0);
                }
            }
            console.log('DIN Rail added');
        }
        
        function testPLC() {
            if (!modelScene) return;
            const cpu = modelScene.addPLCComponent('cpu', {
                x: 0,
                y: 100,
                z: 0
            });
            console.log('CPU added:', cpu);
        }
        
        function testPowerSupply() {
            if (!modelScene) return;
            const ps = modelScene.addPLCComponent('power-supply', {
                x: -100,
                y: 100,
                z: 0
            });
            console.log('Power Supply added:', ps);
        }
        
        function testButton() {
            if (!modelScene) return;
            const button = modelScene.addFieldDevice('button', {
                x: 150,
                y: 50,
                z: 0
            }, {
                color: 0xff0000, // Red
                buttonType: 'momentary'
            });
            console.log('Button added:', button);
            
            // Test button press after 2 seconds
            setTimeout(() => {
                button.press();
                console.log('Button pressed!');
                setTimeout(() => {
                    button.release();
                    console.log('Button released!');
                }, 1000);
            }, 2000);
        }
        
        function testMotor() {
            if (!modelScene) return;
            const motor = modelScene.addFieldDevice('motor', {
                x: -200,
                y: 100,
                z: -100
            }, {
                power: 1500
            });
            console.log('Motor added:', motor);
            
            // Test motor start after 2 seconds
            setTimeout(() => {
                motor.start();
                console.log('Motor started!');
            }, 2000);
        }
        
        function testLED() {
            if (!modelScene) return;
            const led = modelScene.addFieldDevice('led', {
                x: 200,
                y: 50,
                z: 0
            }, {
                color: 'green'
            });
            console.log('LED added:', led);
            
            // Test LED blinking after 2 seconds
            setTimeout(() => {
                led.startBlinking(500);
                console.log('LED blinking!');
            }, 2000);
        }
        
        function testExample() {
            if (!modelScene) return;
            
            // Clear first
            modelScene.clear();
            
            // Add plate
            const plate = modelScene.addMountingSurface('plate', {
                width: 600,
                length: 400,
                thickness: 2
            });
            
            // Add DIN rail
            const dinRail = modelScene.addMountingSurface('din-rail', {
                length: 500
            });
            
            if (dinRail) {
                dinRail.position = { x: 0, y: 50, z: 0 };
                const railMesh = modelScene.scene.children.find(
                    child => child.userData.mounting === dinRail
                );
                if (railMesh) {
                    railMesh.position.set(0, 50, 0);
                }
            }
            
            // Add components
            const powerSupply = modelScene.addPLCComponent('power-supply', {
                x: -200, y: 100, z: 0
            });
            
            const cpu = modelScene.addPLCComponent('cpu', {
                x: -100, y: 100, z: 0
            });
            
            const diModule = modelScene.addPLCComponent('digital-input', {
                x: 0, y: 100, z: 0
            });
            
            console.log('Example created');
        }
        
        function toggleGrid() {
            if (!modelScene) return;
            const visible = modelScene.toggleGrid();
            console.log('Grid visible:', visible);
        }
        
        function toggleAxes() {
            if (!modelScene) return;
            const visible = modelScene.toggleAxes();
            console.log('Axes visible:', visible);
        }
        
        function testTransform() {
            if (!modelScene) return;
            
            // Set transform mode to translate
            modelScene.setTransformMode('translate');
            
            // Select the last added component
            if (modelScene.plcComponents.length > 0) {
                const lastComponent = modelScene.plcComponents[modelScene.plcComponents.length - 1];
                modelScene.selectComponent(lastComponent);
                console.log('Component selected. Use transform gizmo to move/rotate/scale');
                console.log('Press T for translate, R for rotate, S for scale');
            } else {
                console.log('No components to select. Add a component first.');
            }
        }
        
        function loadExternalModel() {
            const input = document.getElementById('modelFile');
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const url = URL.createObjectURL(file);
                const extension = file.name.split('.').pop().toLowerCase();
                
                // Determine format
                let format = 'obj';
                if (extension === 'stl') {
                    format = 'stl';
                }
                
                // Create a test button to load the model into
                const button = modelScene.addFieldDevice('button', {
                    x: 0, y: 100, z: 0
                }, { color: 0x00ff00 });
                
                try {
                    await modelScene.loadComponentModel(button, url, format);
                    console.log('External model loaded successfully');
                } catch (error) {
                    console.error('Failed to load model:', error);
                }
            };
            input.click();
        }
        
        function clearScene() {
            if (!modelScene) return;
            modelScene.clear();
            console.log('Scene cleared');
        }
    </script>
</body>
</html>
