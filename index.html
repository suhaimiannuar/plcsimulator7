<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://drive.google.com https://corsproxy.io https:;">
    <title>PLC Ladder Diagram Simulator</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üîå PLC Ladder Diagram Simulator</h1>
            <div class="header-controls">
                <!-- Ladder Diagram Controls (only show in ladder view) -->
                <div id="ladder-controls" style="display: flex; gap: 10px;">
                    <button id="newDiagram" class="btn btn-secondary">New</button>
                    <button id="saveDiagram" class="btn btn-secondary">Save</button>
                    <button id="loadDiagram" class="btn btn-secondary">Load</button>
                    <button id="librariesBtn" class="btn btn-info">üìö Libraries</button>
                    <button id="clearDiagram" class="btn btn-danger">Clear</button>
                    <div style="border-left: 2px solid #555; margin: 0 10px; height: 30px;"></div>
                </div>
                
                <!-- 3D Model Controls (only show in 3D view) -->
                <div id="model-controls" style="display: none; gap: 10px;">
                    <button id="save3DLayout" class="btn btn-secondary">üíæ Save Layout</button>
                    <button id="load3DLayout" class="btn btn-secondary">üìÇ Load Layout</button>
                    <button id="clear3DLayout" class="btn btn-danger">Clear Scene</button>
                    <div style="border-left: 2px solid #555; margin: 0 10px; height: 30px;"></div>
                </div>
                
                <!-- View Switching Buttons (always visible) -->
                <button id="viewLadder" class="btn btn-primary">üìä Ladder</button>
                <button id="viewDrawing" class="btn btn-secondary">‚úèÔ∏è Schematic Drawing</button>
                <button id="viewPortConfig" class="btn btn-secondary">üîå Port Config</button>
                <button id="view3DModels" class="btn btn-secondary" style="margin-left: auto;">üé≤ 3D Models</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Sidebar - Component Palette -->
            <aside class="sidebar sidebar-left">
                <!-- Ladder Diagram Components (shown in ladder view) -->
                <div id="ladder-components" class="sidebar-content">
                    <h2>Components</h2>
                    
                    <div class="component-category">
                    <h3>Input/Output</h3>
                    <div class="component-grid compact-grid">
                        <button class="component-btn icon-only" data-type="NO_CONTACT" title="Normally Open Contact">
                            <span class="component-icon">‚î§ ‚îú</span>
                        </button>
                        <button class="component-btn icon-only" data-type="NC_CONTACT" title="Normally Closed Contact">
                            <span class="component-icon">‚î§/‚îú</span>
                        </button>
                        <button class="component-btn icon-only" data-type="OUTPUT_COIL" title="Output Coil">
                            <span class="component-icon">( )</span>
                        </button>
                    </div>
                </div>

                <div class="component-category">
                    <h3>Timers</h3>
                    <div class="component-grid compact-grid">
                        <button class="component-btn icon-only" data-type="TON" title="Timer On-Delay">
                            <span class="component-icon">TON</span>
                        </button>
                        <button class="component-btn icon-only" data-type="TOF" title="Timer Off-Delay">
                            <span class="component-icon">TOF</span>
                        </button>
                        <button class="component-btn icon-only" data-type="TP" title="Timer Pulse">
                            <span class="component-icon">TP</span>
                        </button>
                    </div>
                </div>

                <div class="component-category">
                    <h3>Wiring</h3>
                    <div class="component-grid compact-grid">
                        <button class="component-btn icon-only" data-type="HORIZONTAL_WIRE" title="Horizontal Wire">
                            <span class="component-icon">‚îÄ</span>
                        </button>
                        <button class="component-btn icon-only" data-type="VERTICAL_WIRE" title="Vertical Wire">
                            <span class="component-icon">‚îÇ</span>
                        </button>
                        <button class="component-btn icon-only" data-type="BRANCH_POINT" title="Branch Point">
                            <span class="component-icon">‚î¨</span>
                        </button>
                        <button class="component-btn icon-only" data-type="CORNER_DOWN_RIGHT" title="L1 Corner (‚îî)">
                            <span class="component-icon">‚îî</span>
                        </button>
                        <button class="component-btn icon-only" data-type="CORNER_DOWN_LEFT" title="L2 Corner (‚îò)">
                            <span class="component-icon">‚îò</span>
                        </button>
                        <button class="component-btn icon-only" data-type="CORNER_UP_RIGHT" title="Corner Up-Right (‚îå)">
                            <span class="component-icon">‚îå</span>
                        </button>
                        <button class="component-btn icon-only" data-type="CORNER_UP_LEFT" title="Corner Up-Left (‚îê)">
                            <span class="component-icon">‚îê</span>
                        </button>
                    </div>
                </div>

                <div class="tool-section">
                    <h3>Tools</h3>
                    <button id="deleteTool" class="btn btn-danger btn-block">
                        üóëÔ∏è Delete Mode
                    </button>
                    <button id="selectTool" class="btn btn-secondary btn-block">
                        üëÜ Select Mode
                    </button>
                </div>

                <div class="pin-list-section">
                    <h3>Pin Configuration</h3>
                    <div class="pin-list-container">
                        <div class="pin-category">
                            <h4>Inputs</h4>
                            <div id="inputPinList" class="pin-items"></div>
                        </div>
                        <div class="pin-category">
                            <h4>Feedbacks</h4>
                            <div id="feedbackPinList" class="pin-items"></div>
                        </div>
                        <div class="pin-category">
                            <h4>Outputs</h4>
                            <div id="outputPinList" class="pin-items"></div>
                        </div>
                    </div>
                </div>
                </div>
                <!-- End of Ladder Components -->

                <!-- Drawing Components (shown in Drawing view, initially hidden) -->
                <div id="drawing-components" class="sidebar-content" style="display: none;">
                    <h2>Drawing Components</h2>
                    
                    <div class="component-category">
                        <h3>Quick Actions</h3>
                        <button id="clearDrawing" class="btn btn-secondary btn-block">
                            üóëÔ∏è Clear Canvas
                        </button>
                        <button id="saveDrawing" class="btn btn-success btn-block">
                            üíæ Save Schematic
                        </button>
                        <button id="loadDrawing" class="btn btn-info btn-block">
                            üìÇ Load Schematic
                        </button>
                    </div>

                    <div class="component-category">
                        <h3>PLC Components</h3>
                        <div class="component-grid">
                            <button class="drawing-component-btn" data-component="plc">
                                <span class="component-icon">üñ•Ô∏è</span>
                                <span class="component-label">PLC</span>
                            </button>
                            <button class="drawing-component-btn" data-component="power-supply">
                                <span class="component-icon">üîå</span>
                                <span class="component-label">Power Supply</span>
                            </button>
                            <button class="drawing-component-btn" data-component="io-module">
                                <span class="component-icon">üìä</span>
                                <span class="component-label">I/O Module</span>
                            </button>
                        </div>
                    </div>

                    <div class="component-category">
                        <h3>Field Devices</h3>
                        <div class="component-grid">
                            <button class="drawing-component-btn" data-component="motor">
                                <span class="component-icon">‚öôÔ∏è</span>
                                <span class="component-label">Motor</span>
                            </button>
                            <button class="drawing-component-btn" data-component="sensor">
                                <span class="component-icon">üì°</span>
                                <span class="component-label">Sensor</span>
                            </button>
                            <button class="drawing-component-btn" data-component="button">
                                <span class="component-icon">üîò</span>
                                <span class="component-label">Button</span>
                            </button>
                            <button class="drawing-component-btn" data-component="led">
                                <span class="component-icon">üí°</span>
                                <span class="component-label">Indicator</span>
                            </button>
                            <button class="drawing-component-btn" data-component="relay">
                                <span class="component-icon">üîÑ</span>
                                <span class="component-label">Relay</span>
                            </button>
                            <button class="drawing-component-btn" data-component="terminal">
                                <span class="component-icon">üîå</span>
                                <span class="component-label">Terminal</span>
                            </button>
                        </div>
                    </div>

                    <div class="component-category">
                        <h3>Tools</h3>
                        <div class="component-grid">
                            <button class="drawing-tool-btn" data-tool="wire">
                                <span class="component-icon">üìè</span>
                                <span class="component-label">Wire Tool</span>
                            </button>
                            <button class="drawing-tool-btn" data-tool="select">
                                <span class="component-icon">üëÜ</span>
                                <span class="component-label">Select</span>
                            </button>
                            <button class="drawing-tool-btn" data-tool="delete">
                                <span class="component-icon">‚ùå</span>
                                <span class="component-label">Delete</span>
                            </button>
                        </div>
                    </div>

                    <div class="component-category">
                        <h3>Wire Colors</h3>
                        <div class="component-grid">
                            <button class="wire-color-btn active" data-color="#000000" title="Black">
                                <span class="component-icon" style="background: #000000; border-radius: 50%; width: 20px; height: 20px; display: inline-block; border: 2px solid #666;"></span>
                                <span class="component-label">Black</span>
                            </button>
                            <button class="wire-color-btn" data-color="#ff0000" title="Red">
                                <span class="component-icon" style="background: #ff0000; border-radius: 50%; width: 20px; height: 20px; display: inline-block; border: 2px solid #666;"></span>
                                <span class="component-label">Red</span>
                            </button>
                            <button class="wire-color-btn" data-color="#0066ff" title="Blue">
                                <span class="component-icon" style="background: #0066ff; border-radius: 50%; width: 20px; height: 20px; display: inline-block; border: 2px solid #666;"></span>
                                <span class="component-label">Blue</span>
                            </button>
                            <button class="wire-color-btn" data-color="#00cc00" title="Green">
                                <span class="component-icon" style="background: #00cc00; border-radius: 50%; width: 20px; height: 20px; display: inline-block; border: 2px solid #666;"></span>
                                <span class="component-label">Green</span>
                            </button>
                            <button class="wire-color-btn" data-color="#ffcc00" title="Yellow">
                                <span class="component-icon" style="background: #ffcc00; border-radius: 50%; width: 20px; height: 20px; display: inline-block; border: 2px solid #666;"></span>
                                <span class="component-label">Yellow</span>
                            </button>
                            <button class="wire-color-btn" data-color="#ffffff" title="White">
                                <span class="component-icon" style="background: #ffffff; border-radius: 50%; width: 20px; height: 20px; display: inline-block; border: 2px solid #666;"></span>
                                <span class="component-label">White</span>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- End of Drawing Components -->

                <!-- 3D Model Components (shown in 3D view, initially hidden) -->
                <div id="model-components" class="sidebar-content" style="display: none;">
                    <h2>3D Models</h2>
                    
                    <!-- Upload Custom Models -->
                    <div class="component-category">
                        <h3>üì§ Upload Custom Models</h3>
                        <div style="padding: 10px; background: #2c3e50; border-radius: 5px; margin-bottom: 10px;">
                            <button id="uploadSTL" class="btn btn-info btn-small" style="width: 100%; margin-bottom: 5px;">
                                üì¶ Upload STL
                            </button>
                            <button id="uploadOBJ" class="btn btn-info btn-small" style="width: 100%; margin-bottom: 5px;">
                                üé® Upload OBJ + MTL
                            </button>
                            <p style="font-size: 10px; color: #888; margin: 5px 0 0 0;">
                                Files saved to browser storage
                            </p>
                        </div>
                    </div>
                    
                    <!-- Custom Uploaded Models -->
                    <div class="component-category" id="custom-models-section" style="display: none;">
                        <h3>üíæ My Uploaded Models</h3>
                        <div id="custom-model-list"></div>
                    </div>
                    
                    <!-- Catalog Models -->
                    <div class="component-category">
                        <h3>üìö Catalog Models</h3>
                        <p id="model-catalog-info" style="font-size: 11px; color: #888; margin: 5px 0 15px 0;">
                            Loading STL catalog...
                        </p>
                    </div>
                    
                    <div id="model-list-buttons" class="component-category">
                        <button disabled class="btn btn-secondary btn-block">
                            ‚è≥ Loading models...
                        </button>
                    </div>
                </div>
                <!-- End of 3D Model Components -->

            </aside>

            <!-- Center - Ladder Grid -->
            <main class="ladder-workspace" id="ladder-container">
                <div class="workspace-controls">
                    <button id="runPauseSimulation" class="btn btn-success">‚ñ∂Ô∏è Run</button>
                    <button id="resetSimulation" class="btn btn-warning">üîÑ Reset</button>
                    <span class="status-indicator">
                        <span id="statusDot" class="status-dot status-stopped"></span>
                        <span id="statusText">Stopped</span>
                    </span>
                    <div class="timer-controls">
                        <label for="timeElapsed">Time:</label>
                        <span id="timeElapsed" class="time-display">0.00s</span>
                        <label for="scanCycle" style="margin-left: 15px;">Scan Cycle:</label>
                        <input type="number" id="scanCycle" min="10" max="5000" value="100" step="10">
                        <span>ms</span>
                        <label for="speedMultiplier" style="margin-left: 15px;">Speed:</label>
                        <select id="speedMultiplier">
                            <option value="0.1">0.1x (Slow)</option>
                            <option value="0.25">0.25x</option>
                            <option value="0.5">0.5x</option>
                            <option value="1" selected>1x (Normal)</option>
                            <option value="2">2x (Fast)</option>
                            <option value="5">5x</option>
                            <option value="10">10x (Very Fast)</option>
                        </select>
                    </div>
                </div>

                <div class="grid-container">
                    <canvas id="ladderCanvas"></canvas>
                </div>

                <div class="grid-info">
                    <span id="cursorPosition">Position: (-, -)</span>
                    <span id="selectedComponent">Selected: None</span>
                </div>
            </main>

            <!-- 2D Drawing View (initially hidden) -->
            <main class="drawing-workspace" style="display: none;">
                <div id="drawing-container" style="width: 100%; height: calc(100vh - 120px); background: #ffffff; position: relative;">
                    <!-- Drawing canvas will be inserted here -->
                </div>
            </main>

            <!-- Port Config View (initially hidden) -->
            <main class="portconfig-workspace" style="display: none;">
                <div id="portconfig-container" style="width: 100%; height: calc(100vh - 120px); background: #1e1e1e; position: relative; display: flex;">
                    <!-- Left Panel - Model Selection -->
                    <div style="width: 300px; background: #2c3e50; border-right: 2px solid #34495e; overflow-y: auto;">
                        <div style="padding: 20px;">
                            <h2 style="color: #ecf0f1; margin-top: 0;">üì¶ Select Model</h2>
                            
                            <!-- Upload Models -->
                            <div style="background: #34495e; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                                <h3 style="color: #3498db; font-size: 14px; margin-top: 0;">Upload New Model</h3>
                                <button id="portConfigUploadSTL" class="btn btn-info btn-small" style="width: 100%; margin-bottom: 8px;">
                                    üì¶ Upload STL
                                </button>
                                <button id="portConfigUploadOBJ" class="btn btn-info btn-small" style="width: 100%;">
                                    üé® Upload OBJ + MTL
                                </button>
                            </div>
                            
                            <!-- Available Models List -->
                            <div id="portConfigModelList" style="background: #34495e; padding: 15px; border-radius: 5px;">
                                <h3 style="color: #2ecc71; font-size: 14px; margin-top: 0;">Available Models</h3>
                                <div id="portConfigAvailableModels">
                                    <p style="color: #888; font-size: 12px;">Loading models...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Center - 3D Viewer -->
                    <div style="flex: 1; position: relative; background: #263238;">
                        <div id="portconfig-viewer" style="width: 100%; height: 100%;">
                            <!-- Three.js canvas will be inserted here -->
                        </div>
                        
                        <!-- Instructions Overlay -->
                        <div id="portConfigInstructions" style="position: absolute; top: 20px; left: 20px; background: rgba(52, 73, 94, 0.95); color: #ecf0f1; padding: 15px; border-radius: 5px; max-width: 350px; font-size: 12px; z-index: 10;">
                            <h3 style="margin-top: 0; color: #3498db;">üîå Port Configuration</h3>
                            <ol style="margin: 10px 0; padding-left: 20px; line-height: 1.6;">
                                <li>Select a model from the left panel</li>
                                <li>Click on the model surface to add a port</li>
                                <li>Hold <strong>SHIFT</strong> to add labeled port</li>
                                <li>Ports are saved automatically</li>
                            </ol>
                            <div style="background: rgba(46, 204, 113, 0.2); padding: 8px; border-radius: 3px; margin-top: 10px; border-left: 3px solid #2ecc71;">
                                <strong>‚úì Ports will be available in 3D Model view</strong>
                            </div>
                        </div>
                        
                        <!-- Status -->
                        <div id="portconfig-status" style="position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.8); color: white; padding: 10px 15px; border-radius: 5px; font-size: 12px; font-family: monospace; max-width: 400px; z-index: 10;">
                            <div class="log-entry">Select a model to configure ports...</div>
                        </div>
                    </div>
                    
                    <!-- Right Panel - Port Management -->
                    <div style="width: 320px; background: #2c3e50; border-left: 2px solid #34495e; overflow-y: auto; display: flex; flex-direction: column;">
                        <div style="padding: 20px; flex: 1; display: flex; flex-direction: column;">
                            <h2 style="color: #ecf0f1; margin-top: 0;">‚ö° Port Management</h2>
                            
                            <div id="portConfigCurrentModel" style="background: #34495e; padding: 12px; border-radius: 5px; margin-bottom: 15px;">
                                <div style="font-size: 11px; color: #95a5a6; margin-bottom: 5px;">Current Model:</div>
                                <div id="portConfigModelName" style="font-size: 14px; color: #ecf0f1; font-weight: bold;">None selected</div>
                            </div>
                            
                            <div style="background: #34495e; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                                <h3 style="color: #e74c3c; font-size: 14px; margin-top: 0;">üóëÔ∏è Clear Ports</h3>
                                <button id="portConfigClearPorts" class="btn btn-danger btn-small" style="width: 100%;">
                                    Clear All Ports
                                </button>
                            </div>
                            
                            <div style="background: #34495e; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                                <h3 style="color: #3498db; font-size: 14px; margin-top: 0;">üíæ Save/Load</h3>
                                <button id="portConfigSavePorts" class="btn btn-info btn-small" style="width: 100%; margin-bottom: 8px;">
                                    Save Port Config
                                </button>
                                <button id="portConfigLoadPorts" class="btn btn-secondary btn-small" style="width: 100%;">
                                    Load Port Config
                                </button>
                            </div>
                            
                            <div id="portConfigPortsList" style="background: #34495e; padding: 15px; border-radius: 5px; flex: 1; display: flex; flex-direction: column;">
                                <h3 style="color: #2ecc71; font-size: 14px; margin-top: 0; margin-bottom: 10px;">üìç Configured Ports</h3>
                                <div id="portConfigPortsContent" style="flex: 1; overflow-y: auto;">
                                    <p style="color: #888; font-size: 12px;">No ports configured</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </main>

            <!-- 3D Model View (initially hidden) -->
            <main class="model-workspace" style="display: none;">
                <div id="model-viewer-container" style="width: 100%; height: calc(100vh - 120px); background: #f0f0f0; position: relative;">
                    <!-- Three.js canvas will be inserted here -->
                    
                    <!-- ViewCube - Top Right Corner (Canvas-based) -->
                    <div id="viewCubeContainer" style="position: absolute; top: 20px; right: 20px; z-index: 100;">
                        <div style="text-align: center; margin-bottom: 5px; font-size: 11px; color: #555; font-weight: bold;">View Cube</div>
                        <canvas id="viewCubeCanvas" width="150" height="150" style="cursor: pointer; background: rgba(255,255,255,0.1); border-radius: 8px;"></canvas>
                    </div>
                    
                    <!-- Collision Warning - Top of Status Area -->
                    <div id="collision-warning" style="position: absolute; bottom: 180px; left: 20px; background: rgba(220, 53, 69, 0.95); color: white; padding: 12px 18px; border-radius: 5px; font-size: 13px; font-family: Arial, sans-serif; font-weight: bold; max-width: 400px; z-index: 15; display: none; border: 2px solid #ff0000; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">‚ö†Ô∏è</span>
                            <div>
                                <div style="font-size: 14px; margin-bottom: 3px;">COLLISION DETECTED!</div>
                                <div id="collision-details" style="font-size: 11px; font-weight: normal; opacity: 0.9;">Objects are interfering</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="model-viewer-status" style="position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 10px 15px; border-radius: 5px; font-size: 12px; font-family: monospace; max-height: 150px; overflow-y: auto; max-width: 400px; z-index: 10;">
                        <div class="log-entry">Ready to load models...</div>
                    </div>
                </div>
            </main>

            <!-- Right Sidebar - I/O and Properties -->
            <aside class="sidebar sidebar-right">
                <!-- Ladder View Panels (shown when in ladder view) -->
                <div id="ladder-right-panels">
                    <!-- Input Panel -->
                    <div class="io-panel">
                        <h2>Inputs</h2>
                        <div id="inputList" class="io-list">
                            <p class="empty-message">No inputs assigned</p>
                        </div>
                        <button id="addInput" class="btn btn-secondary btn-small">+ Add Input</button>
                    </div>

                    <!-- Feedback Panel -->
                    <div class="io-panel">
                        <h2>Feedbacks</h2>
                        <div id="feedbackList" class="io-list">
                            <p class="empty-message">No feedbacks available</p>
                        </div>
                    </div>

                    <!-- Output Panel -->
                    <div class="io-panel">
                        <h2>Outputs</h2>
                        <div id="outputList" class="io-list">
                            <p class="empty-message">No outputs assigned</p>
                        </div>
                        <button id="addOutput" class="btn btn-secondary btn-small">+ Add Output</button>
                    </div>

                    <!-- Properties Panel -->
                    <div class="properties-panel">
                        <h2>Properties</h2>
                        <div id="propertiesContent" class="properties-content">
                            <p class="empty-message">Select a component to view properties</p>
                        </div>
                    </div>
                </div>

                <!-- 3D Model View Panels (shown when in 3D model view) -->
                <div id="model-right-panels" style="display: none;">
                    <!-- Mounting Configuration -->
                    <div class="io-panel">
                        <h2>üìê Mounting Setup</h2>
                        <div style="padding: 10px;">
                            <label style="font-size: 11px; color: #888; display: block; margin-bottom: 5px;">Mounting Type:</label>
                            <select id="mountingType" style="width: 100%; padding: 5px; margin-bottom: 10px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                                <option value="box">Control Cabinet (Box)</option>
                                <option value="plate">Mounting Plate (Flat)</option>
                                <option value="shelf">Shelf (Open Front)</option>
                            </select>
                            
                            <label style="font-size: 11px; color: #888; display: block; margin-top: 10px;">Width (mm):</label>
                            <input type="number" id="mountingWidth" value="300" min="200" max="2000" step="50" style="width: 100%; padding: 5px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                            
                            <label style="font-size: 11px; color: #888; display: block; margin-top: 8px;">Height (mm):</label>
                            <input type="number" id="mountingHeight" value="200" min="200" max="2000" step="50" style="width: 100%; padding: 5px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                            
                            <label style="font-size: 11px; color: #888; display: block; margin-top: 8px;">Depth (mm):</label>
                            <input type="number" id="mountingDepth" value="200" min="100" max="1000" step="50" style="width: 100%; padding: 5px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                            
                            <button id="applyMounting" class="btn btn-success btn-small" style="margin-top: 10px; width: 100%;">Apply Changes</button>
                        </div>
                    </div>

                    <!-- View Mode Controls -->
                    <div class="io-panel">
                        <h2>üëÅÔ∏è View Mode</h2>
                        <div style="padding: 10px;">
                            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                                <button id="view2D" class="btn btn-success btn-small" style="flex: 1; font-size: 11px;">üìê 2D Top View</button>
                                <button id="view3D" class="btn btn-secondary btn-small" style="flex: 1; font-size: 11px;">üé≤ 3D View</button>
                            </div>
                            <p style="font-size: 10px; color: #888; margin: 0;">
                                <strong>2D Mode:</strong> Arrange items from top-down view (easier layout)<br>
                                <strong>3D Mode:</strong> View-only mode (use 2D to move objects)
                            </p>
                        </div>
                    </div>

                    <!-- Grid & Tools -->
                    <div class="io-panel">
                        <h2>üîß Grid & Tools</h2>
                        <div style="padding: 10px;">
                            <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                <input type="checkbox" id="toggleGrid" checked style="margin-right: 8px;">
                                <span>Show Grid</span>
                            </label>
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 11px; color: #888;">Grid Divisions:</label>
                                <input type="range" id="gridSize" min="10" max="50" value="20" style="width: 100%;">
                                <span id="gridSizeValue" style="font-size: 11px; color: #888;">20</span>
                            </div>
                            <button id="toggleRuler" class="btn btn-secondary btn-small" style="width: 100%; margin-top: 10px;">
                                üìè Ruler: OFF
                            </button>
                            <p style="font-size: 10px; color: #888; margin: 5px 0 0 0;">
                                Click ruler, then click two points to measure distance
                            </p>
                        </div>
                    </div>

                    <!-- Physics Controls -->
                    <div class="io-panel">
                        <h2>‚öôÔ∏è Physics</h2>
                        <div style="padding: 10px;">
                            <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                <input type="checkbox" id="enableGravity" checked style="margin-right: 8px;">
                                <span>Enable Gravity</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                <input type="checkbox" id="enableSnapping" checked style="margin-right: 8px;">
                                <span>Snap to Surface</span>
                            </label>
                            <div style="margin-top: 10px;">
                                <label style="font-size: 11px; color: #888;">Snap Distance:</label>
                                <input type="range" id="snapDistance" min="5" max="200" value="20" style="width: 100%;">
                                <span id="snapDistanceValue" style="font-size: 11px; color: #888;">20mm</span>
                            </div>
                        </div>
                    </div>

                    <!-- Port Editor -->
                    <div class="io-panel">
                        <h2>üîå Connection Ports</h2>
                        <div style="padding: 10px;">
                            <div style="margin-bottom: 10px;">
                                <button id="togglePortEditMode" class="btn btn-secondary btn-small" style="width: 100%;">
                                    üìç Edit Ports Mode: OFF
                                </button>
                            </div>
                            <div id="portEditorControls" style="display: none;">
                                <p style="font-size: 10px; color: #888; margin: 5px 0;">
                                    Click on a model to add connection ports. Shift+Click to remove ports.
                                </p>
                                <div style="margin: 10px 0;">
                                    <label style="font-size: 11px; color: #888;">Port Label:</label>
                                    <input type="text" id="portLabel" placeholder="e.g., L1, N, IN1" style="width: 100%; padding: 5px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                                </div>
                                <div style="margin: 10px 0;">
                                    <label style="font-size: 11px; color: #888;">Port Type:</label>
                                    <select id="portType" style="width: 100%; padding: 5px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                                        <option value="power">‚ö° Power (L/N/PE)</option>
                                        <option value="input">üì• Input Signal</option>
                                        <option value="output">üì§ Output Signal</option>
                                        <option value="data">üíæ Data/Comm</option>
                                    </select>
                                </div>
                                <div style="margin: 10px 0;">
                                    <label style="font-size: 11px; color: #888;">Port Size (mm):</label>
                                    <input type="number" id="portSize" value="10" min="5" max="50" style="width: 100%; padding: 5px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                                </div>
                                <button id="savePortsToFile" class="btn btn-success btn-small" style="width: 100%; margin-top: 5px;">
                                    üíæ Export Port Config
                                </button>
                                <button id="loadPortsFromFile" class="btn btn-secondary btn-small" style="width: 100%; margin-top: 5px;">
                                    üìÅ Import Port Config
                                </button>
                            </div>
                            <div id="portsList" style="margin-top: 10px; font-size: 11px; max-height: 150px; overflow-y: auto;">
                                <p style="color: #888; font-size: 10px;">No ports defined</p>
                            </div>
                        </div>
                    </div>

                    <!-- Wiring System -->
                    <div class="io-panel">
                        <h2>‚ö° Wiring</h2>
                        <div style="padding: 10px;">
                            <div style="margin-bottom: 10px;">
                                <button id="toggleWireMode" class="btn btn-secondary btn-small" style="width: 100%;">
                                    üîå Wire Mode: OFF
                                </button>
                            </div>
                            <div id="wireControls" style="display: none;">
                                <p style="font-size: 10px; color: #888; margin: 5px 0;">
                                    Click on first port, then second port to create wire
                                </p>
                                <div style="margin: 10px 0;">
                                    <label style="font-size: 11px; color: #888;">Wire Type:</label>
                                    <select id="wireType" style="width: 100%; padding: 5px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                                        <option value="power">‚ö° Power (L/N/PE)</option>
                                        <option value="signal">üìä Signal</option>
                                        <option value="ground">üîå Ground</option>
                                        <option value="data">üíæ Data/Comm</option>
                                    </select>
                                </div>
                                <div style="margin: 10px 0;">
                                    <label style="font-size: 11px; color: #888;">Wire Gauge:</label>
                                    <select id="wireGauge" style="width: 100%; padding: 5px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                                        <option value="22">22 AWG (0.5mm¬≤)</option>
                                        <option value="20">20 AWG (0.75mm¬≤)</option>
                                        <option value="18">18 AWG (1.0mm¬≤)</option>
                                        <option value="16" selected>16 AWG (1.5mm¬≤)</option>
                                        <option value="14">14 AWG (2.5mm¬≤)</option>
                                        <option value="12">12 AWG (4.0mm¬≤)</option>
                                    </select>
                                </div>
                                <button id="clearAllWires" class="btn btn-danger btn-small" style="width: 100%; margin-top: 5px;">
                                    üóëÔ∏è Clear All Wires
                                </button>
                                <button id="exportWireList" class="btn btn-success btn-small" style="width: 100%; margin-top: 5px;">
                                    üìã Export Wire List
                                </button>
                            </div>
                            <div id="wiresList" style="margin-top: 10px; font-size: 11px; max-height: 150px; overflow-y: auto;">
                                <p style="color: #888; font-size: 10px;">No wires connected</p>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Object Properties -->
                    <div class="properties-panel">
                        <h2>üì¶ Selected Object</h2>
                        <div id="model-properties-content" class="properties-content">
                            <p class="empty-message">Select a component to view properties</p>
                        </div>
                    </div>

                    <!-- Scene Objects List -->
                    <div class="io-panel">
                        <h2>üóÇÔ∏è Scene Objects</h2>
                        <div id="scene-objects-list" style="padding: 5px; max-height: 150px; overflow-y: auto;">
                            <p class="empty-message">No objects in scene</p>
                        </div>
                        <button id="clearScene" class="btn btn-danger btn-small" style="margin-top: 10px;">Clear All</button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Modal for Pin Assignment -->
    <div id="pinModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Assign Pin</h2>
            <form id="pinAssignmentForm">
                <div class="form-group">
                    <label for="pinNumber">Pin:</label>
                    <select id="pinNumber" required>
                        <option value="">Select pin...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pinLabel">Label:</label>
                    <input type="text" id="pinLabel" placeholder="e.g., Start Button" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Assign</button>
                    <button type="button" class="btn btn-secondary" id="cancelPin">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Timer Configuration -->
    <div id="timerModal" class="modal">
        <div class="modal-content">
            <span class="close-timer">&times;</span>
            <h2 id="timerModalTitle">Configure Timer</h2>
            <form id="timerConfigForm">
                <div class="form-group">
                    <label for="timerLabel">Label:</label>
                    <input type="text" id="timerLabel" placeholder="e.g., Delay Start" required>
                </div>
                <div class="form-group">
                    <label for="timerPreset">Preset Time (seconds):</label>
                    <input type="number" id="timerPreset" min="0.1" max="3600" step="0.1" value="1.0" required>
                </div>
                <div class="form-group">
                    <label>Timer Type:</label>
                    <p id="timerTypeDisplay" style="color: #9C27B0; font-weight: bold;">TON - On Delay</p>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" id="cancelTimer">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Libraries -->
    <div id="librariesModal" class="modal">
        <div class="modal-content">
            <span class="close-libraries">&times;</span>
            <h2>Example Circuit Libraries</h2>
            <div class="library-container">
                <p>Load a pre-built circuit example:</p>
                <div id="libraryList" class="library-list">
                    <button class="library-item" data-library="simple-on-off">
                        <strong>Simple ON/OFF Circuit</strong>
                        <p>Basic start/stop control with one input and one output</p>
                    </button>
                    <button class="library-item" data-library="and-circuit">
                        <strong>AND Circuit</strong>
                        <p>Two inputs in series (both must be ON)</p>
                    </button>
                    <button class="library-item" data-library="or-circuit">
                        <strong>OR Circuit</strong>
                        <p>Two inputs in parallel (either can be ON)</p>
                    </button>
                    <button class="library-item" data-library="complex-and-or">
                        <strong>Complex AND/OR Circuit</strong>
                        <p>Combination of series and parallel logic</p>
                    </button>
                    <button class="library-item" data-library="latch-circuit">
                        <strong>Latch Circuit</strong>
                        <p>Start/stop with feedback latching</p>
                    </button>
                    <button class="library-item" data-library="timer-circuit">
                        <strong>Timer Circuit</strong>
                        <p>Delayed output using TON timer</p>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Library -->
    <script src="analysis-v2.js"></script>
    
    <!-- Three.js Library (for 3D viewer) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
    
    <!-- Rapier Physics Engine -->
    <script src="https://cdn.jsdelivr.net/npm/@dimforge/rapier3d-compat@0.11.2/rapier.min.js"></script>
    
    <!-- PLC Simulator Modules (Load order is important!) -->
    <!-- 1. Configuration & Constants -->
    <script src="js/ladder/config.js"></script>
    
    <!-- 2. State Management -->
    <script src="js/ladder/state.js"></script>
    
    <!-- 3. DOM References -->
    <script src="js/ladder/dom.js"></script>
    
    <!-- 4. Utility Functions -->
    <script src="js/ladder/canvas.js"></script>
    <script src="js/ladder/keyboard.js"></script>
    
    <!-- 5. Core Features -->
    <script src="js/ladder/components.js"></script>
    <script src="js/ladder/modals.js"></script>
    <script src="js/ladder/rendering.js"></script>
    <script src="js/ladder/ui.js"></script>
    <script src="js/ladder/simulation.js"></script>
    <script src="js/ladder/diagram.js"></script>
    
    <!-- 6. Initialization -->
    <script src="js/ladder/init.js"></script>
    
    <!-- 7. Entry Point -->
    <script src="js/ladder/main.js"></script>
    
    <!-- 2D Drawing System -->
    <script src="js/drawing/canvas.js"></script>
    <script src="js/drawing/init.js"></script>
    
    <!-- View Toggle Controls -->
    <script src="js/shared/viewSwitching.js"></script>
    
    <!-- 3D Model System - Modular Files -->
    <script src="js/model/modelScene.js"></script>
    <script src="js/model/modelPhysics.js"></script>
    <script src="js/model/modelLoader.js"></script>
    <script src="js/model/modelPorts.js"></script>
    <script src="js/model/modelWiring.js"></script>
    <script src="js/model/modelTools.js"></script>
    <script src="js/model/modelStorage.js"></script>
    
    <!-- 3D Model Viewer Script -->
    <script>
        // Interactive 3D Scene Manager with Physics (using modular classes)
        class Interactive3DScene {
            constructor(container, statusDiv) {
                this.container = container;
                this.statusDiv = statusDiv;
                
                // Initialize manager instances
                this.sceneManager = new ModelSceneManager();
                this.physicsManager = new ModelPhysicsManager();
                this.loaderManager = new ModelLoaderManager();
                this.portsManager = new ModelPortsManager();
                this.wiringManager = new ModelWiringManager();
                this.toolsManager = new ModelToolsManager();
                this.storageManager = new ModelStorageManager();
                
                // Initialize state properties
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.orbitControls = null;
                this.transformControls = null;
                this.world = null;
                this.rigidBodies = new Map();
                this.sceneObjects = [];
                this.selectedObject = null;
                this.snapEnabled = true;
                this.snapDistance = 20;
                this.gravityEnabled = true;
                this.mountingSurfaces = [];
                this.boundaryWalls = [];
                this.viewMode = '2d';
                this.interactionEnabled = true;
                
                this.mountingConfig = {
                    type: 'box',
                    width: 300,
                    height: 200,
                    depth: 200
                };
                
                this.gridHelper = null;
                this.gridVisible = true;
                this.gridSize = 20;
                
                this.rulerMode = false;
                this.portEditMode = false;
                this.modelPorts = new Map();
                this.portMarkers = [];
                
                this.wireMode = false;
                this.wires = [];
                this.selectedPortForWire = null;
                this.wireIdCounter = 0;
                
                this.collisionMeshes = new Map();
                
                this.init();
            }
            
            async init() {
                // Delegate to scene manager
                const sceneSetup = this.sceneManager.setupScene(this.container, this.statusDiv);
                this.scene = sceneSetup.scene;
                this.perspectiveCamera = sceneSetup.perspectiveCamera;
                this.orthographicCamera = sceneSetup.orthographicCamera;
                this.camera = sceneSetup.camera;
                this.renderer = sceneSetup.renderer;
                this.is2DMode = sceneSetup.is2DMode;
                
                this.sceneManager.setupLighting(this.scene);
                
                const controls = this.sceneManager.setupControls(this, this.camera, this.renderer, this.scene);
                this.orbitControls = controls.orbitControls;
                this.transformControls = controls.transformControls;
                
                const viewCube = this.sceneManager.setupViewCube(this);
                if (viewCube) {
                    this.viewCubeScene = viewCube.viewCubeScene;
                    this.viewCubeCamera = viewCube.viewCubeCamera;
                    this.viewCubeRenderer = viewCube.viewCubeRenderer;
                    this.viewCubeMesh = viewCube.viewCubeMesh;
                }
                
                this.sceneManager.setupMousePicking(this, this.renderer, this.camera, this.transformControls);
                
                await this.physicsManager.setupPhysics(this);
                this.physicsManager.createMounting(this);
                this.animate();
                this.log('‚úÖ Interactive 3D Scene initialized', 'success');
            }
            
            // All methods now delegate to respective managers
            animate() {
                requestAnimationFrame(() => this.animate());
                if (this.world) {
                    this.world.step();
                    this.sceneObjects.forEach(obj => {
                        const body = this.rigidBodies.get(obj);
                        if (body) {
                            const isDragging = this.selectedObject === obj && this.transformControls.dragging;
                            if (isDragging) {
                                body.setTranslation(obj.position, true);
                                body.setRotation(obj.quaternion, true);
                                body.setLinvel({ x: 0, y: 0, z: 0 }, true);
                                body.setAngvel({ x: 0, y: 0, z: 0 }, true);
                            } else {
                                const position = body.translation();
                                obj.position.set(position.x, position.y, position.z);
                                const rotation = body.rotation();
                                obj.quaternion.set(rotation.x, rotation.y, rotation.z, rotation.w);
                            }
                            this.physicsManager.enforceObjectBoundaries(this, obj);
                        }
                    });
                }
                this.orbitControls.update();
                this.renderer.render(this.scene, this.camera);
                if (this.viewCubeRenderer) {
                    this.sceneManager.renderViewCube(this.viewCubeMesh, this.viewCubeRenderer, this.viewCubeScene, this.viewCubeCamera, this.camera);
                }
                this.toolsManager.checkCollisions(this);
            }
            
            // Scene management delegates
            setupControls() { /* Handled by sceneManager in init */ }
            setupMousePicking() { /* Handled by sceneManager */ }
            setupViewCube() { /* Handled by sceneManager */ }
            renderViewCube() { this.sceneManager.renderViewCube(this.viewCubeMesh, this.viewCubeRenderer, this.viewCubeScene, this.viewCubeCamera, this.camera); }
            setView(viewName) { this.sceneManager.setView(this, viewName); }
            animateCamera(targetPos, targetLookAt) { this.sceneManager.animateCamera(this, targetPos, targetLookAt); }
            switchTo2DView() { this.sceneManager.switchTo2DView(this); }
            switchTo3DView() { this.sceneManager.switchTo3DView(this); }
            selectObject(obj) { this.sceneManager.selectObject(this, obj); }
            deselectObject() { this.sceneManager.deselectObject(this); }
            updatePropertiesPanel() { this.sceneManager.updatePropertiesPanel(this); }
            updateSceneObjectsList() { this.sceneManager.updateSceneObjectsList(this); }
            deleteSelected() { this.sceneManager.deleteSelected(this); }
            clearScene() { this.sceneManager.clearScene(this); }
            
            // Physics delegates
            setupPhysics() { return this.physicsManager.setupPhysics(this); }
            createMounting() { this.physicsManager.createMounting(this); }
            rebuildMounting() { this.physicsManager.rebuildMounting(this); }
            addPhysicsBody(mesh, geometry) { this.physicsManager.addPhysicsBody(this, mesh, geometry); }
            addPhysicsBodyFromBBox(object, size) { this.physicsManager.addPhysicsBodyFromBBox(this, object, size); }
            updatePhysicsBody(mesh) { this.physicsManager.updatePhysicsBody(this, mesh); }
            enforceObjectBoundaries(obj) { this.physicsManager.enforceObjectBoundaries(this, obj); }
            checkSnapping(mesh) { this.physicsManager.checkSnapping(this, mesh); }
            
            // Loader delegates
            loadSTL(file, name, modelData) { return this.loaderManager.loadSTL(this, file, name, modelData); }
            loadOBJ(objFile, mtlFile, name, modelData) { return this.loaderManager.loadOBJ(this, objFile, mtlFile, name, modelData); }
            uploadSTLFile() { this.loaderManager.uploadSTLFile(this); }
            uploadOBJFile() { this.loaderManager.uploadOBJFile(this); }
            loadCustomModel(modelId) { return this.loaderManager.loadCustomModel(this, modelId); }
            deleteCustomModel(modelId) { this.loaderManager.deleteCustomModel(this, modelId); }
            refreshCustomModelsList() { this.loaderManager.refreshCustomModelsList(this); }
            
            // Ports delegates
            togglePortEditMode() { this.portsManager.togglePortEditMode(this); }
            addPortToModel(modelObj, worldPosition, shiftKey) { this.portsManager.addPortToModel(this, modelObj, worldPosition, shiftKey); }
            updatePortMarkers() { this.portsManager.updatePortMarkers(this); }
            updatePortsList() { this.portsManager.updatePortsList(this); }
            exportPortsConfig() { this.portsManager.exportPortsConfig(this); }
            importPortsConfig(file) { this.portsManager.importPortsConfig(this, file); }
            clearPortMarkers() { this.portsManager.clearPortMarkers(this); }
            
            // Wiring delegates
            toggleWireMode() { this.wiringManager.toggleWireMode(this); }
            handlePortClickForWiring(port, portMarker) { this.wiringManager.handlePortClickForWiring(this, port, portMarker); }
            createWire(portA, portB, wireType, wireGauge) { this.wiringManager.createWire(this, portA, portB, wireType, wireGauge); }
            updateWiresList() { this.wiringManager.updateWiresList(this); }
            deleteWire(wireId) { this.wiringManager.deleteWire(this, wireId); }
            clearAllWires() { this.wiringManager.clearAllWires(this); }
            exportWireList() { this.wiringManager.exportWireList(this); }
            
            // Tools delegates
            toggleRuler() { this.toolsManager.toggleRuler(this); }
            handleRulerClick(raycaster, mouse) { this.toolsManager.handleRulerClick(this, raycaster, mouse); }
            clearRuler() { this.toolsManager.clearRuler(this); }
            updateGrid() { this.toolsManager.updateGrid(this); }
            toggleGrid() { this.toolsManager.toggleGrid(this); }
            setGridSize(divisions) { this.toolsManager.setGridSize(this, divisions); }
            checkCollisions() { this.toolsManager.checkCollisions(this); }
            
            // Storage delegates
            save3DLayout() { this.storageManager.save3DLayout(this); }
            load3DLayout() { this.storageManager.load3DLayout(this); }
            
            // Logging method
            log(message, type = 'info') {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.style.color = type === 'success' ? '#2ecc71' :
                                   type === 'error' ? '#e74c3c' :
                                   type === 'warning' ? '#f39c12' : '#3498db';
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                this.statusDiv.appendChild(entry);
                this.statusDiv.scrollTop = this.statusDiv.scrollHeight;
                
                // Keep only last 20 messages
                while (this.statusDiv.children.length > 20) {
                    this.statusDiv.removeChild(this.statusDiv.firstChild);
                }
            }
        }
        
        // Initialize Interactive 3D Scene
        let viewer3D = null;
        const catalog = new STLModelCatalog();
        
        function init3DViewer() {
            if (viewer3D) return; // Already initialized
            
            const container = document.getElementById('model-viewer-container');
            const statusDiv = document.getElementById('model-viewer-status');
            
            viewer3D = new Interactive3DScene(container, statusDiv);
            window.viewer3D = viewer3D; // Make globally accessible
            
            // Setup physics controls
            setupPhysicsControls();
            
            // Setup view mode controls
            setupViewModeControls();
            
            // Setup 3D layout save/load buttons
            setup3DLayoutControls();
        }
        
        function setup3DLayoutControls() {
            const save3DBtn = document.getElementById('save3DLayout');
            const load3DBtn = document.getElementById('load3DLayout');
            const clear3DBtn = document.getElementById('clear3DLayout');
            
            if (save3DBtn) {
                save3DBtn.addEventListener('click', () => {
                    console.log('Save button clicked, viewer3D:', window.viewer3D);
                    if (window.viewer3D) {
                        window.viewer3D.save3DLayout();
                    } else {
                        console.error('viewer3D not initialized');
                    }
                });
            }
            
            if (load3DBtn) {
                load3DBtn.addEventListener('click', () => {
                    console.log('Load button clicked, viewer3D:', window.viewer3D);
                    if (window.viewer3D) {
                        window.viewer3D.load3DLayout();
                    } else {
                        console.error('viewer3D not initialized');
                    }
                });
            }
            
            if (clear3DBtn) {
                clear3DBtn.addEventListener('click', () => {
                    console.log('Clear button clicked, viewer3D:', window.viewer3D);
                    if (window.viewer3D) {
                        if (confirm('Are you sure you want to clear the entire scene?')) {
                            window.viewer3D.clearScene();
                        }
                    } else {
                        console.error('viewer3D not initialized');
                    }
                });
            }
            
            console.log('3D Layout controls initialized');
        }
        
        function setupViewModeControls() {
            const view2DBtn = document.getElementById('view2D');
            const view3DBtn = document.getElementById('view3D');
            
            if (view2DBtn && view3DBtn) {
                // Start in 2D mode (button already highlighted)
                view2DBtn.classList.add('btn-success');
                view2DBtn.classList.remove('btn-secondary');
                view3DBtn.classList.remove('btn-success');
                view3DBtn.classList.add('btn-secondary');
                
                view2DBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.switchTo2DView();
                        view2DBtn.classList.add('btn-success');
                        view2DBtn.classList.remove('btn-secondary');
                        view3DBtn.classList.remove('btn-success');
                        view3DBtn.classList.add('btn-secondary');
                    }
                });
                
                view3DBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.switchTo3DView();
                        view3DBtn.classList.add('btn-success');
                        view3DBtn.classList.remove('btn-secondary');
                        view2DBtn.classList.remove('btn-success');
                        view2DBtn.classList.add('btn-secondary');
                    }
                });
            }
        }
        
        function setupPhysicsControls() {
            // Mounting configuration controls
            const mountingType = document.getElementById('mountingType');
            const mountingWidth = document.getElementById('mountingWidth');
            const mountingHeight = document.getElementById('mountingHeight');
            const mountingDepth = document.getElementById('mountingDepth');
            const applyMountingBtn = document.getElementById('applyMounting');
            
            if (applyMountingBtn) {
                applyMountingBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.mountingConfig.type = mountingType.value;
                        viewer3D.mountingConfig.width = parseFloat(mountingWidth.value);
                        viewer3D.mountingConfig.height = parseFloat(mountingHeight.value);
                        viewer3D.mountingConfig.depth = parseFloat(mountingDepth.value);
                        viewer3D.rebuildMounting();
                    }
                });
            }
            
            // Physics controls
            const gravityCheckbox = document.getElementById('enableGravity');
            const snappingCheckbox = document.getElementById('enableSnapping');
            const snapDistanceSlider = document.getElementById('snapDistance');
            const snapDistanceValue = document.getElementById('snapDistanceValue');
            const clearSceneBtn = document.getElementById('clearScene');
            
            if (gravityCheckbox) {
                gravityCheckbox.addEventListener('change', (e) => {
                    if (viewer3D) {
                        viewer3D.gravityEnabled = e.target.checked;
                        viewer3D.log(`‚öôÔ∏è Gravity ${e.target.checked ? 'enabled' : 'disabled'}`, 'info');
                    }
                });
            }
            
            if (snappingCheckbox) {
                snappingCheckbox.addEventListener('change', (e) => {
                    if (viewer3D) {
                        viewer3D.snapEnabled = e.target.checked;
                        viewer3D.log(`üß≤ Snapping ${e.target.checked ? 'enabled' : 'disabled'}`, 'info');
                    }
                });
            }
            
            if (snapDistanceSlider) {
                snapDistanceSlider.addEventListener('input', (e) => {
                    if (viewer3D) {
                        viewer3D.snapDistance = parseFloat(e.target.value);
                        snapDistanceValue.textContent = `${e.target.value}mm`;
                    }
                });
            }
            
            // Grid controls
            const toggleGridCheckbox = document.getElementById('toggleGrid');
            const gridSizeSlider = document.getElementById('gridSize');
            const gridSizeValue = document.getElementById('gridSizeValue');
            
            if (toggleGridCheckbox) {
                toggleGridCheckbox.addEventListener('change', (e) => {
                    if (viewer3D) {
                        viewer3D.toggleGrid();
                    }
                });
            }
            
            if (gridSizeSlider) {
                gridSizeSlider.addEventListener('input', (e) => {
                    if (viewer3D) {
                        viewer3D.setGridSize(parseInt(e.target.value));
                        gridSizeValue.textContent = e.target.value;
                    }
                });
            }
            
            // Ruler control
            const toggleRulerBtn = document.getElementById('toggleRuler');
            
            if (toggleRulerBtn) {
                toggleRulerBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.toggleRuler();
                        const isOn = viewer3D.rulerMode;
                        toggleRulerBtn.textContent = `üìè Ruler: ${isOn ? 'ON' : 'OFF'}`;
                        toggleRulerBtn.classList.toggle('btn-success', isOn);
                        toggleRulerBtn.classList.toggle('btn-secondary', !isOn);
                    }
                });
            }
            
            // Port Editor controls
            const togglePortEditBtn = document.getElementById('togglePortEditMode');
            const savePortsBtn = document.getElementById('savePortsToFile');
            const loadPortsBtn = document.getElementById('loadPortsFromFile');
            
            if (togglePortEditBtn) {
                togglePortEditBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.togglePortEditMode();
                    }
                });
            }
            
            if (savePortsBtn) {
                savePortsBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.exportPortsConfig();
                    }
                });
            }
            
            if (loadPortsBtn) {
                loadPortsBtn.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file && viewer3D) {
                            viewer3D.importPortsConfig(file);
                        }
                    };
                    input.click();
                });
            }
            
            if (clearSceneBtn) {
                clearSceneBtn.addEventListener('click', () => {
                    if (viewer3D && confirm('Clear all objects from scene?')) {
                        viewer3D.clearScene();
                    }
                });
            }
        }
        
        // Load model catalog and create buttons
        async function loadModelButtons() {
            try {
                const models = await catalog.loadCatalog();
                const container = document.getElementById('model-list-buttons');
                const infoText = document.getElementById('model-catalog-info');
                
                container.innerHTML = '';
                
                models.forEach((model) => {
                    const button = document.createElement('button');
                    button.className = 'btn btn-success btn-block';
                    button.style.cssText = 'margin-bottom: 8px; text-align: left; padding: 10px;';
                    
                    // Show format indicator
                    const formatIcon = model.format === 'obj' ? 'üé®' : 'üì¶';
                    const formatText = model.format === 'obj' ? 'OBJ+MTL' : 'STL';
                    
                    button.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 3px;">${formatIcon} ${model.name}</div>
                        <div style="font-size: 10px; opacity: 0.8;">${model.size} ‚Ä¢ ${formatText}</div>
                    `;
                    button.onclick = () => {
                        if (viewer3D) {
                            if (model.format === 'obj') {
                                // Load OBJ+MTL
                                // Check if URL is absolute (starts with http/https) or relative
                                const objPath = model.file.startsWith('http') ? model.file : `libs/model/${model.file}`;
                                const mtlPath = model.mtlFile.startsWith('http') ? model.mtlFile : `libs/model/${model.mtlFile}`;
                                viewer3D.loadOBJ(objPath, mtlPath, model.name, model);
                            } else {
                                // Load STL
                                // Check if URL is absolute (starts with http/https) or relative
                                const filePath = model.file.startsWith('http') ? model.file : `libs/model/${model.file}`;
                                viewer3D.loadSTL(filePath, model.name, model);
                            }
                        }
                    };
                    container.appendChild(button);
                });
                
                infoText.textContent = `‚úÖ ${models.length} CAD models available - Click to add to scene`;
                infoText.style.color = '#2ecc71';
                
            } catch (error) {
                console.error('Failed to load model catalog:', error);
            }
        }
        
        function setupCustomModelUpload() {
            const uploadSTLBtn = document.getElementById('uploadSTL');
            const uploadOBJBtn = document.getElementById('uploadOBJ');
            
            if (uploadSTLBtn) {
                uploadSTLBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.uploadSTLFile();
                    }
                });
            }
            
            if (uploadOBJBtn) {
                uploadOBJBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.uploadOBJFile();
                    }
                });
            }
            
            // Load existing custom models
            if (viewer3D) {
                viewer3D.refreshCustomModelsList();
            }
        }
        
        function setupWireSystem() {
            const toggleWireModeBtn = document.getElementById('toggleWireMode');
            const clearWiresBtn = document.getElementById('clearWires');
            const exportWireListBtn = document.getElementById('exportWireList');
            
            if (toggleWireModeBtn) {
                toggleWireModeBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.toggleWireMode();
                        toggleWireModeBtn.textContent = viewer3D.wireMode ? '‚ö° Wire Mode: ON' : 'üîå Wire Mode: OFF';
                        toggleWireModeBtn.style.background = viewer3D.wireMode ? '#27ae60' : '#34495e';
                    }
                });
            }
            
            if (clearWiresBtn) {
                clearWiresBtn.addEventListener('click', () => {
                    if (viewer3D && confirm('Clear all wires?')) {
                        viewer3D.clearAllWires();
                    }
                });
            }
            
            if (exportWireListBtn) {
                exportWireListBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.exportWireList();
                    }
                });
            }
        }
        
        // Initialize 3D viewer when needed
        document.addEventListener('DOMContentLoaded', function() {
            // 3D viewer will be initialized by viewSwitching.js when switching to 3D view
            window.init3DModelViewer = function() {
                init3DViewer();
                loadModelButtons();
                setupCustomModelUpload();
                setupWireSystem();
            };
        });
        
        // ==================== PORT CONFIG VIEWER ====================
        
        let portConfigViewer = null;
        
        class PortConfigViewer {
            constructor() {
                this.container = document.getElementById('portconfig-viewer');
                this.statusDiv = document.getElementById('portconfig-status');
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.controls = null;
                this.currentModel = null;
                this.currentModelName = null;
                this.portMarkers = [];
                this.modelPorts = new Map(); // Store ports per model
                this.portEditMode = true; // Always in port edit mode
                
                this.init();
            }
            
            init() {
                console.log('Initializing Port Config Viewer...');
                console.log('Container:', this.container);
                console.log('Container size:', this.container.clientWidth, 'x', this.container.clientHeight);
                
                // Setup Three.js scene
                this.scene = new THREE.Scene();
                this.scene.background = new THREE.Color(0x263238);
                
                // Get container dimensions (fallback if not ready)
                const width = this.container.clientWidth || 800;
                const height = this.container.clientHeight || 600;
                
                // Camera
                this.camera = new THREE.PerspectiveCamera(
                    45,
                    width / height,
                    0.1,
                    10000
                );
                this.camera.position.set(300, 300, 300);
                this.camera.lookAt(0, 0, 0);
                
                // Renderer
                this.renderer = new THREE.WebGLRenderer({ antialias: true });
                this.renderer.setSize(width, height);
                this.renderer.setPixelRatio(window.devicePixelRatio);
                this.container.appendChild(this.renderer.domElement);
                
                console.log('Renderer size set to:', width, 'x', height);
                
                // Lighting
                const ambientLight = new THREE.AmbientLight(0x404040, 2);
                this.scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(100, 200, 100);
                this.scene.add(directionalLight);
                
                const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
                directionalLight2.position.set(-100, -200, -100);
                this.scene.add(directionalLight2);
                
                // Grid
                const gridHelper = new THREE.GridHelper(500, 20, 0x444444, 0x222222);
                this.scene.add(gridHelper);
                
                // Add axes helper for orientation
                const axesHelper = new THREE.AxesHelper(100);
                this.scene.add(axesHelper);
                
                // Add a test cube to verify rendering is working
                const testGeometry = new THREE.BoxGeometry(50, 50, 50);
                const testMaterial = new THREE.MeshPhongMaterial({ color: 0xff0000, wireframe: true });
                const testCube = new THREE.Mesh(testGeometry, testMaterial);
                testCube.position.set(0, 25, 0);
                this.scene.add(testCube);
                this.testCube = testCube; // Store reference
                
                console.log('Test cube added at origin');
                
                // Controls
                this.controls = new THREE.OrbitControls(this.camera, this.renderer.domElement);
                this.controls.enableDamping = true;
                this.controls.dampingFactor = 0.05;
                
                // Mouse picking
                this.setupMousePicking();
                
                // Handle window resize
                window.addEventListener('resize', () => this.onWindowResize());
                
                // Start animation loop
                this.animate();
                
                console.log('Port Config Viewer initialized successfully');
                this.log('Port Config Viewer initialized - You should see a red test cube', 'success');
            }
            
            setupMousePicking() {
                const raycaster = new THREE.Raycaster();
                const mouse = new THREE.Vector2();
                
                this.renderer.domElement.addEventListener('click', (event) => {
                    // Don't register clicks while dragging
                    if (this.controls.isDragging) {
                        console.log('Ignoring click - camera is dragging');
                        return;
                    }
                    
                    if (!this.currentModel) {
                        this.log('‚ö†Ô∏è Select a model first!', 'warning');
                        return;
                    }
                    
                    const rect = this.renderer.domElement.getBoundingClientRect();
                    mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                    mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                    
                    console.log('Mouse click:', { x: mouse.x, y: mouse.y });
                    
                    raycaster.setFromCamera(mouse, this.camera);
                    
                    // Raycast against all objects in scene for debugging
                    const allIntersects = raycaster.intersectObjects(this.scene.children, true);
                    console.log('All intersects:', allIntersects.length);
                    
                    // Raycast specifically against the model
                    const intersects = raycaster.intersectObject(this.currentModel, true);
                    console.log('Model intersects:', intersects.length, intersects);
                    
                    if (intersects.length > 0) {
                        const clickPosition = intersects[0].point;
                        console.log('Port position:', clickPosition);
                        this.addPort(clickPosition, event.shiftKey);
                    } else {
                        this.log('‚ö†Ô∏è Click on the model surface to add a port', 'warning');
                    }
                });
                
                // Track dragging state
                this.controls.addEventListener('start', () => {
                    this.controls.isDragging = false;
                });
                
                this.controls.addEventListener('change', () => {
                    this.controls.isDragging = true;
                });
                
                this.controls.addEventListener('end', () => {
                    setTimeout(() => {
                        this.controls.isDragging = false;
                    }, 100); // Small delay to avoid click after drag
                });
            }
            
            async loadModel(modelData) {
                console.log('Loading model:', modelData);
                
                // Clear current model
                if (this.currentModel) {
                    this.scene.remove(this.currentModel);
                    this.clearPortMarkers();
                }
                
                // Remove test cube if it exists
                if (this.testCube) {
                    this.scene.remove(this.testCube);
                    this.testCube = null;
                }
                
                this.log(`Loading ${modelData.name}...`, 'info');
                
                try {
                    let loadedModel = null;
                    
                    // Construct proper file paths
                    let filePath = modelData.file;
                    let mtlPath = modelData.mtlFile;
                    
                    // If file doesn't start with http, prepend libs/model/
                    if (!filePath.startsWith('http')) {
                        filePath = `libs/model/${filePath}`;
                    }
                    if (mtlPath && !mtlPath.startsWith('http')) {
                        mtlPath = `libs/model/${mtlPath}`;
                    }
                    
                    console.log('File path:', filePath);
                    console.log('MTL path:', mtlPath);
                    
                    if (modelData.format === 'stl') {
                        const loader = new THREE.STLLoader();
                        const geometry = await new Promise((resolve, reject) => {
                            loader.load(
                                filePath, 
                                resolve, 
                                (progress) => {
                                    const percent = (progress.loaded / progress.total * 100).toFixed(0);
                                    this.log(`Loading... ${percent}%`, 'info');
                                },
                                reject
                            );
                        });
                        
                        const material = new THREE.MeshPhongMaterial({
                            color: 0x3498db,
                            specular: 0x111111,
                            shininess: 200
                        });
                        loadedModel = new THREE.Mesh(geometry, material);
                        
                    } else if (modelData.format === 'obj') {
                        // Load MTL first
                        const mtlLoader = new THREE.MTLLoader();
                        const materialPath = mtlPath || filePath.replace('.obj', '.mtl');
                        
                        const materials = await new Promise((resolve, reject) => {
                            mtlLoader.load(
                                materialPath,
                                resolve,
                                undefined,
                                (error) => {
                                    console.warn('MTL loading failed, using default material:', error);
                                    resolve(null); // Continue with default material
                                }
                            );
                        });
                        
                        if (materials) {
                            materials.preload();
                        }
                        
                        // Load OBJ
                        const objLoader = new THREE.OBJLoader();
                        if (materials) {
                            objLoader.setMaterials(materials);
                        }
                        
                        loadedModel = await new Promise((resolve, reject) => {
                            objLoader.load(
                                filePath,
                                resolve,
                                (progress) => {
                                    if (progress.total > 0) {
                                        const percent = (progress.loaded / progress.total * 100).toFixed(0);
                                        this.log(`Loading... ${percent}%`, 'info');
                                    }
                                },
                                reject
                            );
                        });
                    }
                    
                    if (loadedModel) {
                        console.log('Model loaded successfully:', loadedModel);
                        
                        this.currentModel = loadedModel;
                        this.currentModelName = modelData.name;
                        this.scene.add(loadedModel);
                        
                        console.log('Model added to scene');
                        
                        // Center camera on model
                        const box = new THREE.Box3().setFromObject(loadedModel);
                        const center = box.getCenter(new THREE.Vector3());
                        const size = box.getSize(new THREE.Vector3());
                        const maxDim = Math.max(size.x, size.y, size.z);
                        
                        console.log('Model bounds:', {
                            center: center,
                            size: size,
                            maxDim: maxDim
                        });
                        
                        const fov = this.camera.fov * (Math.PI / 180);
                        let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
                        cameraZ *= 2.0; // Increased multiplier for better view
                        
                        this.camera.position.set(center.x + cameraZ, center.y + cameraZ, center.z + cameraZ);
                        this.controls.target.copy(center);
                        this.controls.update();
                        
                        console.log('Camera positioned at:', this.camera.position);
                        console.log('Camera looking at:', center);
                        
                        // Update UI
                        document.getElementById('portConfigModelName').textContent = modelData.name;
                        
                        // Load existing ports if any
                        if (this.modelPorts.has(modelData.name)) {
                            const ports = this.modelPorts.get(modelData.name);
                            ports.forEach(port => {
                                this.createPortMarker(port);
                            });
                        }
                        
                        this.updatePortsList();
                        this.log(`‚úÖ Loaded: ${modelData.name}`, 'success');
                    } else {
                        console.error('Model loaded but is null/undefined');
                        this.log('‚ùå Failed to load model', 'error');
                    }
                    
                } catch (error) {
                    console.error('Error loading model:', error);
                    this.log(`‚ùå Failed to load model: ${error.message}`, 'error');
                }
            }
            
            addPort(worldPosition, withLabel = false) {
                let label = `Port_${this.portMarkers.length + 1}`;
                
                if (withLabel) {
                    label = prompt('Enter port label:', label);
                    if (!label) return;
                }
                
                const port = {
                    label: label,
                    worldPosition: {
                        x: worldPosition.x,
                        y: worldPosition.y,
                        z: worldPosition.z
                    },
                    localPosition: worldPosition.clone()
                };
                
                // Store port for current model
                if (!this.modelPorts.has(this.currentModelName)) {
                    this.modelPorts.set(this.currentModelName, []);
                }
                this.modelPorts.get(this.currentModelName).push(port);
                
                // Create visual marker
                this.createPortMarker(port);
                this.updatePortsList();
                
                this.log(`‚úÖ Port added: ${label}`, 'success');
            }
            
            createPortMarker(port) {
                // Port sphere
                const geometry = new THREE.SphereGeometry(5, 16, 16);
                const material = new THREE.MeshBasicMaterial({ 
                    color: 0xff0000,
                    transparent: true,
                    opacity: 0.8
                });
                const marker = new THREE.Mesh(geometry, material);
                marker.position.copy(port.worldPosition);
                marker.userData = { port: port };
                
                this.scene.add(marker);
                this.portMarkers.push(marker);
                
                // Port label
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.width = 256;
                canvas.height = 64;
                context.fillStyle = 'rgba(0, 0, 0, 0.7)';
                context.fillRect(0, 0, canvas.width, canvas.height);
                context.fillStyle = 'white';
                context.font = 'bold 24px Arial';
                context.textAlign = 'center';
                context.fillText(port.label, 128, 40);
                
                const texture = new THREE.CanvasTexture(canvas);
                const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
                const sprite = new THREE.Sprite(spriteMaterial);
                sprite.position.copy(port.worldPosition);
                sprite.position.y += 15;
                sprite.scale.set(30, 7.5, 1);
                
                this.scene.add(sprite);
                this.portMarkers.push(sprite);
            }
            
            clearPortMarkers() {
                this.portMarkers.forEach(marker => {
                    this.scene.remove(marker);
                    if (marker.geometry) marker.geometry.dispose();
                    if (marker.material) {
                        if (marker.material.map) marker.material.map.dispose();
                        marker.material.dispose();
                    }
                });
                this.portMarkers = [];
            }
            
            clearAllPorts() {
                if (!this.currentModelName) {
                    this.log('No model selected', 'warning');
                    return;
                }
                
                if (!confirm(`Clear all ports for ${this.currentModelName}?`)) return;
                
                this.modelPorts.delete(this.currentModelName);
                this.clearPortMarkers();
                this.updatePortsList();
                this.log('All ports cleared', 'info');
            }
            
            updatePortsList() {
                const content = document.getElementById('portConfigPortsContent');
                
                if (!this.currentModelName || !this.modelPorts.has(this.currentModelName)) {
                    content.innerHTML = '<p style="color: #888; font-size: 12px;">No ports configured</p>';
                    return;
                }
                
                const ports = this.modelPorts.get(this.currentModelName);
                content.innerHTML = ''; // Clear content
                
                ports.forEach((port, index) => {
                    const portDiv = document.createElement('div');
                    portDiv.style.cssText = 'background: #2c3e50; padding: 10px; margin-bottom: 8px; border-radius: 3px; border-left: 3px solid #e74c3c;';
                    
                    // Port info
                    const labelDiv = document.createElement('div');
                    labelDiv.style.cssText = 'font-weight: bold; color: #ecf0f1; margin-bottom: 5px; display: flex; justify-content: space-between; align-items: center;';
                    labelDiv.innerHTML = `
                        <span>${port.label}</span>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="portConfigViewer.editPortLabel(${index})" 
                                    style="background: #3498db; border: none; color: white; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">
                                ‚úèÔ∏è Edit
                            </button>
                            <button onclick="portConfigViewer.deletePort(${index})" 
                                    style="background: #e74c3c; border: none; color: white; padding: 2px 8px; border-radius: 3px; cursor: pointer; font-size: 10px;">
                                üóëÔ∏è Delete
                            </button>
                        </div>
                    `;
                    
                    const coordDiv = document.createElement('div');
                    coordDiv.style.cssText = 'font-size: 10px; color: #95a5a6;';
                    coordDiv.textContent = `X: ${port.worldPosition.x.toFixed(1)}  Y: ${port.worldPosition.y.toFixed(1)}  Z: ${port.worldPosition.z.toFixed(1)}`;
                    
                    portDiv.appendChild(labelDiv);
                    portDiv.appendChild(coordDiv);
                    content.appendChild(portDiv);
                });
            }
            
            editPortLabel(index) {
                if (!this.currentModelName || !this.modelPorts.has(this.currentModelName)) return;
                
                const ports = this.modelPorts.get(this.currentModelName);
                if (index < 0 || index >= ports.length) return;
                
                const port = ports[index];
                const newLabel = prompt('Enter new port label:', port.label);
                
                if (newLabel && newLabel !== port.label) {
                    port.label = newLabel;
                    
                    // Update visual marker
                    this.clearPortMarkers();
                    ports.forEach(p => this.createPortMarker(p));
                    
                    this.updatePortsList();
                    this.log(`‚úèÔ∏è Port label updated: ${newLabel}`, 'success');
                }
            }
            
            deletePort(index) {
                if (!this.currentModelName || !this.modelPorts.has(this.currentModelName)) return;
                
                const ports = this.modelPorts.get(this.currentModelName);
                if (index < 0 || index >= ports.length) return;
                
                const port = ports[index];
                if (!confirm(`Delete port "${port.label}"?`)) return;
                
                // Remove from array
                ports.splice(index, 1);
                
                // Update visual markers
                this.clearPortMarkers();
                ports.forEach(p => this.createPortMarker(p));
                
                this.updatePortsList();
                this.log(`üóëÔ∏è Port deleted: ${port.label}`, 'info');
            }
            
            savePorts() {
                const portsData = {};
                this.modelPorts.forEach((ports, modelName) => {
                    portsData[modelName] = ports;
                });
                
                const json = JSON.stringify(portsData, null, 2);
                const blob = new Blob([json], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'port-config.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                this.log('‚úÖ Port configuration saved', 'success');
            }
            
            loadPorts() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    try {
                        const text = await file.text();
                        const portsData = JSON.parse(text);
                        
                        this.modelPorts.clear();
                        Object.entries(portsData).forEach(([modelName, ports]) => {
                            this.modelPorts.set(modelName, ports);
                        });
                        
                        // Refresh current model ports if loaded
                        if (this.currentModelName && this.modelPorts.has(this.currentModelName)) {
                            this.clearPortMarkers();
                            const ports = this.modelPorts.get(this.currentModelName);
                            ports.forEach(port => this.createPortMarker(port));
                            this.updatePortsList();
                        }
                        
                        this.log('‚úÖ Port configuration loaded', 'success');
                    } catch (error) {
                        this.log(`‚ùå Failed to load: ${error.message}`, 'error');
                    }
                };
                
                input.click();
            }
            
            onWindowResize() {
                if (!this.container) return;
                this.camera.aspect = this.container.clientWidth / this.container.clientHeight;
                this.camera.updateProjectionMatrix();
                this.renderer.setSize(this.container.clientWidth, this.container.clientHeight);
            }
            
            animate() {
                requestAnimationFrame(() => this.animate());
                if (this.controls) this.controls.update();
                if (this.renderer && this.scene && this.camera) {
                    this.renderer.render(this.scene, this.camera);
                }
            }
            
            log(message, type = 'info') {
                if (!this.statusDiv) return;
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.style.color = type === 'success' ? '#2ecc71' :
                                   type === 'error' ? '#e74c3c' :
                                   type === 'warning' ? '#f39c12' : '#3498db';
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                this.statusDiv.appendChild(entry);
                this.statusDiv.scrollTop = this.statusDiv.scrollHeight;
                
                while (this.statusDiv.children.length > 10) {
                    this.statusDiv.removeChild(this.statusDiv.firstChild);
                }
            }
        }
        
        // Initialize Port Config Viewer
        window.initPortConfigViewer = async function() {
            if (portConfigViewer) return; // Already initialized
            
            portConfigViewer = new PortConfigViewer();
            
            // Store models globally for button access
            window.portConfigModels = [];
            
            // Setup model list
            try {
                const catalogResponse = await fetch('libs/model/catalog.json');
                const catalog = await catalogResponse.json();
                const modelListDiv = document.getElementById('portConfigAvailableModels');
                
                modelListDiv.innerHTML = ''; // Clear loading message
                
                // Add catalog models
                catalog.models.forEach((model, index) => {
                    window.portConfigModels.push(model);
                    const formatIcon = model.format === 'obj' ? 'üé®' : 'üì¶';
                    
                    const button = document.createElement('button');
                    button.className = 'btn btn-secondary btn-small';
                    button.style.cssText = 'width: 100%; margin-bottom: 5px; text-align: left;';
                    button.innerHTML = `${formatIcon} ${model.name}`;
                    button.onclick = () => {
                        portConfigViewer.loadModel(model);
                    };
                    
                    modelListDiv.appendChild(button);
                });
                
                // Add custom models from localStorage
                const customModels = JSON.parse(localStorage.getItem('customModels') || '[]');
                if (customModels.length > 0) {
                    const hr = document.createElement('hr');
                    hr.style.cssText = 'border-color: #555; margin: 10px 0;';
                    modelListDiv.appendChild(hr);
                    
                    const label = document.createElement('div');
                    label.style.cssText = 'font-size: 11px; color: #888; margin-bottom: 5px;';
                    label.textContent = 'Custom Models:';
                    modelListDiv.appendChild(label);
                    
                    customModels.forEach(model => {
                        window.portConfigModels.push(model);
                        const formatIcon = model.format === 'obj' ? 'üé®' : 'üì¶';
                        
                        const button = document.createElement('button');
                        button.className = 'btn btn-secondary btn-small';
                        button.style.cssText = 'width: 100%; margin-bottom: 5px; text-align: left;';
                        button.innerHTML = `${formatIcon} ${model.name}`;
                        button.onclick = () => {
                            portConfigViewer.loadModel(model);
                        };
                        
                        modelListDiv.appendChild(button);
                    });
                }
                
            } catch (error) {
                console.error('Failed to load model catalog:', error);
                document.getElementById('portConfigAvailableModels').innerHTML = 
                    '<p style="color: #e74c3c; font-size: 11px;">Failed to load models</p>';
            }
            
            // Setup buttons
            document.getElementById('portConfigClearPorts').onclick = () => portConfigViewer.clearAllPorts();
            document.getElementById('portConfigSavePorts').onclick = () => portConfigViewer.savePorts();
            document.getElementById('portConfigLoadPorts').onclick = () => portConfigViewer.loadPorts();
            
            // Upload buttons (reuse existing upload functions from main 3D viewer)
            document.getElementById('portConfigUploadSTL').onclick = () => {
                alert('STL upload for port config - To be implemented');
            };
            document.getElementById('portConfigUploadOBJ').onclick = () => {
                alert('OBJ upload for port config - To be implemented');
            };
        };
        
        // ==================== END PORT CONFIG VIEWER ====================
    </script>
</body>
</html>

