<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdnjs.cloudflare.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://drive.google.com https://corsproxy.io https:;">
    <title>PLC Ladder Diagram Simulator</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1>üîå PLC Ladder Diagram Simulator</h1>
            <div class="header-controls">
                <!-- Ladder Diagram Controls (only show in ladder view) -->
                <div id="ladder-controls" style="display: flex; gap: 10px;">
                    <button id="newDiagram" class="btn btn-secondary">New</button>
                    <button id="saveDiagram" class="btn btn-secondary">Save</button>
                    <button id="loadDiagram" class="btn btn-secondary">Load</button>
                    <button id="librariesBtn" class="btn btn-info">üìö Libraries</button>
                    <button id="clearDiagram" class="btn btn-danger">Clear</button>
                    <div style="border-left: 2px solid #555; margin: 0 10px; height: 30px;"></div>
                </div>
                
                <!-- 3D Model Controls (only show in 3D view) -->
                <div id="model-controls" style="display: none; gap: 10px;">
                    <button id="save3DLayout" class="btn btn-secondary">üíæ Save Layout</button>
                    <button id="load3DLayout" class="btn btn-secondary">üìÇ Load Layout</button>
                    <button id="clear3DLayout" class="btn btn-danger">Clear Scene</button>
                    <div style="border-left: 2px solid #555; margin: 0 10px; height: 30px;"></div>
                </div>
                
                <!-- View Switching Buttons (always visible) -->
                <button id="viewLadder" class="btn btn-primary">üìä Ladder</button>
                <button id="viewDrawing" class="btn btn-secondary">‚úèÔ∏è Schematic Drawing</button>
                <button id="viewPortConfig" class="btn btn-secondary">üîå Port Config</button>
                <button id="view3DModels" class="btn btn-secondary" style="margin-left: auto;">üé≤ 3D Models</button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Left Sidebar - Component Palette -->
            <aside class="sidebar sidebar-left">
                <!-- Ladder Diagram Components (shown in ladder view) -->
                <div id="ladder-components" class="sidebar-content">
                    <h2>Components</h2>
                    
                    <div class="component-category">
                    <h3>Input/Output</h3>
                    <div class="component-grid compact-grid">
                        <button class="component-btn icon-only" data-type="NO_CONTACT" title="Normally Open Contact">
                            <span class="component-icon">‚î§ ‚îú</span>
                        </button>
                        <button class="component-btn icon-only" data-type="NC_CONTACT" title="Normally Closed Contact">
                            <span class="component-icon">‚î§/‚îú</span>
                        </button>
                        <button class="component-btn icon-only" data-type="OUTPUT_COIL" title="Output Coil">
                            <span class="component-icon">( )</span>
                        </button>
                    </div>
                </div>

                <div class="component-category">
                    <h3>Timers</h3>
                    <div class="component-grid compact-grid">
                        <button class="component-btn icon-only" data-type="TON" title="Timer On-Delay">
                            <span class="component-icon">TON</span>
                        </button>
                        <button class="component-btn icon-only" data-type="TOF" title="Timer Off-Delay">
                            <span class="component-icon">TOF</span>
                        </button>
                        <button class="component-btn icon-only" data-type="TP" title="Timer Pulse">
                            <span class="component-icon">TP</span>
                        </button>
                    </div>
                </div>

                <div class="component-category">
                    <h3>Wiring</h3>
                    <div class="component-grid compact-grid">
                        <button class="component-btn icon-only" data-type="HORIZONTAL_WIRE" title="Horizontal Wire">
                            <span class="component-icon">‚îÄ</span>
                        </button>
                        <button class="component-btn icon-only" data-type="VERTICAL_WIRE" title="Vertical Wire">
                            <span class="component-icon">‚îÇ</span>
                        </button>
                        <button class="component-btn icon-only" data-type="BRANCH_POINT" title="Branch Point">
                            <span class="component-icon">‚î¨</span>
                        </button>
                        <button class="component-btn icon-only" data-type="CORNER_DOWN_RIGHT" title="L1 Corner (‚îî)">
                            <span class="component-icon">‚îî</span>
                        </button>
                        <button class="component-btn icon-only" data-type="CORNER_DOWN_LEFT" title="L2 Corner (‚îò)">
                            <span class="component-icon">‚îò</span>
                        </button>
                        <button class="component-btn icon-only" data-type="CORNER_UP_RIGHT" title="Corner Up-Right (‚îå)">
                            <span class="component-icon">‚îå</span>
                        </button>
                        <button class="component-btn icon-only" data-type="CORNER_UP_LEFT" title="Corner Up-Left (‚îê)">
                            <span class="component-icon">‚îê</span>
                        </button>
                    </div>
                </div>

                <div class="tool-section">
                    <h3>Tools</h3>
                    <button id="deleteTool" class="btn btn-danger btn-block">
                        üóëÔ∏è Delete Mode
                    </button>
                    <button id="selectTool" class="btn btn-secondary btn-block">
                        üëÜ Select Mode
                    </button>
                </div>

                <div class="pin-list-section">
                    <h3>Pin Configuration</h3>
                    <div class="pin-list-container">
                        <div class="pin-category">
                            <h4>Inputs</h4>
                            <div id="inputPinList" class="pin-items"></div>
                        </div>
                        <div class="pin-category">
                            <h4>Feedbacks</h4>
                            <div id="feedbackPinList" class="pin-items"></div>
                        </div>
                        <div class="pin-category">
                            <h4>Outputs</h4>
                            <div id="outputPinList" class="pin-items"></div>
                        </div>
                    </div>
                </div>
                </div>
                <!-- End of Ladder Components -->

                <!-- Drawing Components (shown in Drawing view, initially hidden) -->
                <div id="drawing-components" class="sidebar-content" style="display: none;">
                    <h2>Drawing Components</h2>
                    
                    <div class="component-category">
                        <h3>Quick Actions</h3>
                        <button id="clearDrawing" class="btn btn-secondary btn-block">
                            üóëÔ∏è Clear Canvas
                        </button>
                        <button id="saveDrawing" class="btn btn-success btn-block">
                            üíæ Save Schematic
                        </button>
                        <button id="loadDrawing" class="btn btn-info btn-block">
                            üìÇ Load Schematic
                        </button>
                    </div>

                    <div class="component-category">
                        <h3>PLC Components</h3>
                        <div class="component-grid">
                            <button class="drawing-component-btn" data-component="plc">
                                <span class="component-icon">üñ•Ô∏è</span>
                                <span class="component-label">PLC</span>
                            </button>
                            <button class="drawing-component-btn" data-component="power-supply">
                                <span class="component-icon">üîå</span>
                                <span class="component-label">Power Supply</span>
                            </button>
                            <button class="drawing-component-btn" data-component="io-module">
                                <span class="component-icon">üìä</span>
                                <span class="component-label">I/O Module</span>
                            </button>
                        </div>
                    </div>

                    <div class="component-category">
                        <h3>Field Devices</h3>
                        <div class="component-grid">
                            <button class="drawing-component-btn" data-component="motor">
                                <span class="component-icon">‚öôÔ∏è</span>
                                <span class="component-label">Motor</span>
                            </button>
                            <button class="drawing-component-btn" data-component="sensor">
                                <span class="component-icon">üì°</span>
                                <span class="component-label">Sensor</span>
                            </button>
                            <button class="drawing-component-btn" data-component="button">
                                <span class="component-icon">üîò</span>
                                <span class="component-label">Button</span>
                            </button>
                            <button class="drawing-component-btn" data-component="led">
                                <span class="component-icon">üí°</span>
                                <span class="component-label">Indicator</span>
                            </button>
                            <button class="drawing-component-btn" data-component="relay">
                                <span class="component-icon">üîÑ</span>
                                <span class="component-label">Relay</span>
                            </button>
                            <button class="drawing-component-btn" data-component="terminal">
                                <span class="component-icon">üîå</span>
                                <span class="component-label">Terminal</span>
                            </button>
                        </div>
                    </div>

                    <div class="component-category">
                        <h3>Tools</h3>
                        <div class="component-grid">
                            <button class="drawing-tool-btn" data-tool="wire">
                                <span class="component-icon">üìè</span>
                                <span class="component-label">Wire Tool</span>
                            </button>
                            <button class="drawing-tool-btn" data-tool="select">
                                <span class="component-icon">üëÜ</span>
                                <span class="component-label">Select</span>
                            </button>
                            <button class="drawing-tool-btn" data-tool="delete">
                                <span class="component-icon">‚ùå</span>
                                <span class="component-label">Delete</span>
                            </button>
                        </div>
                    </div>

                    <div class="component-category">
                        <h3>Wire Colors</h3>
                        <div class="component-grid">
                            <button class="wire-color-btn active" data-color="#000000" title="Black">
                                <span class="component-icon" style="background: #000000; border-radius: 50%; width: 20px; height: 20px; display: inline-block; border: 2px solid #666;"></span>
                                <span class="component-label">Black</span>
                            </button>
                            <button class="wire-color-btn" data-color="#ff0000" title="Red">
                                <span class="component-icon" style="background: #ff0000; border-radius: 50%; width: 20px; height: 20px; display: inline-block; border: 2px solid #666;"></span>
                                <span class="component-label">Red</span>
                            </button>
                            <button class="wire-color-btn" data-color="#0066ff" title="Blue">
                                <span class="component-icon" style="background: #0066ff; border-radius: 50%; width: 20px; height: 20px; display: inline-block; border: 2px solid #666;"></span>
                                <span class="component-label">Blue</span>
                            </button>
                            <button class="wire-color-btn" data-color="#00cc00" title="Green">
                                <span class="component-icon" style="background: #00cc00; border-radius: 50%; width: 20px; height: 20px; display: inline-block; border: 2px solid #666;"></span>
                                <span class="component-label">Green</span>
                            </button>
                            <button class="wire-color-btn" data-color="#ffcc00" title="Yellow">
                                <span class="component-icon" style="background: #ffcc00; border-radius: 50%; width: 20px; height: 20px; display: inline-block; border: 2px solid #666;"></span>
                                <span class="component-label">Yellow</span>
                            </button>
                            <button class="wire-color-btn" data-color="#ffffff" title="White">
                                <span class="component-icon" style="background: #ffffff; border-radius: 50%; width: 20px; height: 20px; display: inline-block; border: 2px solid #666;"></span>
                                <span class="component-label">White</span>
                            </button>
                        </div>
                    </div>
                </div>
                <!-- End of Drawing Components -->

                <!-- 3D Model Components (shown in 3D view, initially hidden) -->
                <div id="model-components" class="sidebar-content" style="display: none;">
                    <h2>3D Models</h2>
                    
                    <!-- Upload Custom Models -->
                    <div class="component-category">
                        <h3>üì§ Upload Custom Models</h3>
                        <div style="padding: 10px; background: #2c3e50; border-radius: 5px; margin-bottom: 10px;">
                            <button id="uploadSTL" class="btn btn-info btn-small" style="width: 100%; margin-bottom: 5px;">
                                üì¶ Upload STL
                            </button>
                            <button id="uploadOBJ" class="btn btn-info btn-small" style="width: 100%; margin-bottom: 5px;">
                                üé® Upload OBJ + MTL
                            </button>
                            <p style="font-size: 10px; color: #888; margin: 5px 0 0 0;">
                                Files saved to browser storage
                            </p>
                        </div>
                    </div>
                    
                    <!-- Custom Uploaded Models -->
                    <div class="component-category" id="custom-models-section" style="display: none;">
                        <h3>üíæ My Uploaded Models</h3>
                        <div id="custom-model-list"></div>
                    </div>
                    
                    <!-- Catalog Models -->
                    <div class="component-category">
                        <h3>üìö Catalog Models</h3>
                        <p id="model-catalog-info" style="font-size: 11px; color: #888; margin: 5px 0 15px 0;">
                            Loading STL catalog...
                        </p>
                    </div>
                    
                    <div id="model-list-buttons" class="component-category">
                        <button disabled class="btn btn-secondary btn-block">
                            ‚è≥ Loading models...
                        </button>
                    </div>
                </div>
                <!-- End of 3D Model Components -->

                <!-- Port Config Components (shown in Port Config view, initially hidden) -->
                <div id="portconfig-components" class="sidebar-content" style="display: none;">
                    <h2>üì¶ Model Selection</h2>
                    
                    <!-- Upload New Models -->
                    <div class="component-category">
                        <h3>üì§ Upload New Model</h3>
                        <div style="padding: 10px; background: #2c3e50; border-radius: 5px; margin-bottom: 10px;">
                            <button id="portConfigUploadSTL" class="btn btn-info btn-small" style="width: 100%; margin-bottom: 5px;">
                                üì¶ Upload STL
                            </button>
                            <button id="portConfigUploadOBJ" class="btn btn-info btn-small" style="width: 100%;">
                                üé® Upload OBJ + MTL
                            </button>
                            <p style="font-size: 10px; color: #888; margin: 5px 0 0 0;">
                                Upload models to configure connection ports
                            </p>
                        </div>
                    </div>
                    
                    <!-- Available Models -->
                    <div class="component-category">
                        <h3>üìö Available Models</h3>
                        <div id="portConfigAvailableModels" style="max-height: 500px; overflow-y: auto;">
                            <p style="color: #888; font-size: 12px;">Loading models...</p>
                        </div>
                    </div>
                </div>
                <!-- End of Port Config Components -->

            </aside>

            <!-- Center - Ladder Grid -->
            <main class="ladder-workspace" id="ladder-container">
                <div class="workspace-controls">
                    <button id="runPauseSimulation" class="btn btn-success">‚ñ∂Ô∏è Run</button>
                    <button id="resetSimulation" class="btn btn-warning">üîÑ Reset</button>
                    <span class="status-indicator">
                        <span id="statusDot" class="status-dot status-stopped"></span>
                        <span id="statusText">Stopped</span>
                    </span>
                    <div class="timer-controls">
                        <label for="timeElapsed">Time:</label>
                        <span id="timeElapsed" class="time-display">0.00s</span>
                        <label for="scanCycle" style="margin-left: 15px;">Scan Cycle:</label>
                        <input type="number" id="scanCycle" min="10" max="5000" value="100" step="10">
                        <span>ms</span>
                        <label for="speedMultiplier" style="margin-left: 15px;">Speed:</label>
                        <select id="speedMultiplier">
                            <option value="0.1">0.1x (Slow)</option>
                            <option value="0.25">0.25x</option>
                            <option value="0.5">0.5x</option>
                            <option value="1" selected>1x (Normal)</option>
                            <option value="2">2x (Fast)</option>
                            <option value="5">5x</option>
                            <option value="10">10x (Very Fast)</option>
                        </select>
                    </div>
                </div>

                <div class="grid-container">
                    <canvas id="ladderCanvas"></canvas>
                </div>

                <div class="grid-info">
                    <span id="cursorPosition">Position: (-, -)</span>
                    <span id="selectedComponent">Selected: None</span>
                </div>
            </main>

            <!-- 2D Drawing View (initially hidden) -->
            <main class="drawing-workspace" style="display: none;">
                <div id="drawing-container" style="width: 100%; height: calc(100vh - 120px); background: #ffffff; position: relative;">
                    <!-- Drawing canvas will be inserted here -->
                </div>
            </main>

            <!-- Port Config View (initially hidden) -->
            <main class="portconfig-workspace" style="display: none;">
                <div id="portconfig-viewer" style="width: 100%; height: calc(100vh - 120px); background: #263238; position: relative;">
                    <!-- Three.js canvas will be inserted here -->
                    
                    <!-- Instructions Overlay -->
                    <div id="portConfigInstructions" style="position: absolute; top: 20px; left: 20px; background: rgba(52, 73, 94, 0.95); color: #ecf0f1; padding: 15px; border-radius: 5px; max-width: 400px; font-size: 12px; z-index: 10;">
                        <h3 style="margin-top: 0; color: #3498db;">üîå Port Configuration</h3>
                        <div style="background: rgba(52, 152, 219, 0.2); padding: 8px; border-radius: 3px; margin-bottom: 8px; border-left: 3px solid #3498db;">
                            <strong>üñ±Ô∏è Mouse Controls:</strong><br>
                            ‚Ä¢ Left-click: Select surface / Add port<br>
                            ‚Ä¢ Right-click + drag: <strong>Pan view</strong><br>
                            ‚Ä¢ Scroll: Zoom in/out<br>
                            ‚Ä¢ Left-drag: Rotate view
                        </div>
                        <ol style="margin: 10px 0; padding-left: 20px; line-height: 1.6;">
                            <li>Select a model from the left panel</li>
                            <li>Click on the model surface - the surface will be <span style="color: #2ecc71; font-weight: bold;">highlighted in green</span></li>
                            <li>A <span style="color: #e74c3c; font-weight: bold;">red dot</span> marks where you clicked</li>
                            <li>A <span style="color: #00ffff; font-weight: bold;">cyan arrow</span> shows the port direction (surface normal)</li>
                            <li>Use cubic view buttons to change viewing angle</li>
                            <li>Click <strong>"View Normal"</strong> to look perpendicular to the selected surface</li>
                            <li>Hold <strong>SHIFT + Click</strong> to add a labeled port</li>
                            <li>Use <strong>"Clear Dots"</strong> button to remove temporary dots</li>
                        </ol>
                        <div style="background: rgba(46, 204, 113, 0.2); padding: 8px; border-radius: 3px; margin-top: 10px; border-left: 3px solid #2ecc71;">
                            <strong>‚úì Ports with direction data will be available in 3D Model view</strong>
                        </div>
                    </div>
                    
                    <!-- Cubic View Controls -->
                    <div id="portConfigCubicViews" style="position: absolute; top: 20px; right: 20px; background: rgba(52, 73, 94, 0.95); color: #ecf0f1; padding: 15px; border-radius: 5px; z-index: 10;">
                        <h4 style="margin: 0 0 10px 0; color: #3498db; font-size: 12px;">üìê View Controls</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 60px); gap: 5px;">
                            <button onclick="portConfigViewer.setCubicView('top')" class="btn btn-secondary btn-small" style="font-size: 10px; padding: 8px 4px;">Top</button>
                            <button onclick="portConfigViewer.setCubicView('front')" class="btn btn-secondary btn-small" style="font-size: 10px; padding: 8px 4px;">Front</button>
                            <button onclick="portConfigViewer.setCubicView('back')" class="btn btn-secondary btn-small" style="font-size: 10px; padding: 8px 4px;">Back</button>
                            <button onclick="portConfigViewer.setCubicView('left')" class="btn btn-secondary btn-small" style="font-size: 10px; padding: 8px 4px;">Left</button>
                            <button onclick="portConfigViewer.setCubicView('bottom')" class="btn btn-secondary btn-small" style="font-size: 10px; padding: 8px 4px;">Bottom</button>
                            <button onclick="portConfigViewer.setCubicView('right')" class="btn btn-secondary btn-small" style="font-size: 10px; padding: 8px 4px;">Right</button>
                            <button onclick="portConfigViewer.setCubicView('iso')" class="btn btn-info btn-small" style="font-size: 10px; padding: 8px 4px; grid-column: span 3;">Isometric</button>
                        </div>
                        <button id="portConfigViewNormal" class="btn btn-warning btn-small" style="font-size: 10px; padding: 8px 4px; width: 100%; margin-top: 8px;">
                            üìç View Normal
                        </button>
                        <div style="font-size: 9px; color: #95a5a6; margin-top: 5px; text-align: center;">Right-click = Pan</div>
                    </div>
                    
                    <!-- Status -->
                    <div id="portconfig-status" style="position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.8); color: white; padding: 10px 15px; border-radius: 5px; font-size: 12px; font-family: monospace; max-width: 400px; z-index: 10;">
                        <div class="log-entry">Select a model to configure ports...</div>
                    </div>
                </div>
            </main>

            <!-- 3D Model View (initially hidden) -->
            <main class="model-workspace" style="display: none;">
                <div id="model-viewer-container" style="width: 100%; height: calc(100vh - 120px); background: #f0f0f0; position: relative;">
                    <!-- Three.js canvas will be inserted here -->
                    
                    <!-- 2D Wire Routing Overlay Canvas (for EasyEDA-style routing) -->
                    <canvas id="wire-routing-overlay" 
                            style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
                                   pointer-events: none; z-index: 50; display: none; 
                                   background: transparent;">
                    </canvas>
                    
                    <!-- ViewCube - Top Right Corner (Canvas-based) -->
                    <div id="viewCubeContainer" style="position: absolute; top: 20px; right: 20px; z-index: 100;">
                        <div style="text-align: center; margin-bottom: 5px; font-size: 11px; color: #555; font-weight: bold;">View Cube</div>
                        <canvas id="viewCubeCanvas" width="150" height="150" style="cursor: pointer; background: rgba(255,255,255,0.1); border-radius: 8px;"></canvas>
                    </div>
                    
                    <!-- Collision Warning - Top of Status Area -->
                    <div id="collision-warning" style="position: absolute; bottom: 180px; left: 20px; background: rgba(220, 53, 69, 0.95); color: white; padding: 12px 18px; border-radius: 5px; font-size: 13px; font-family: Arial, sans-serif; font-weight: bold; max-width: 400px; z-index: 15; display: none; border: 2px solid #ff0000; box-shadow: 0 4px 8px rgba(0,0,0,0.3);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="font-size: 24px;">‚ö†Ô∏è</span>
                            <div>
                                <div style="font-size: 14px; margin-bottom: 3px;">COLLISION DETECTED!</div>
                                <div id="collision-details" style="font-size: 11px; font-weight: normal; opacity: 0.9;">Objects are interfering</div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="model-viewer-status" style="position: absolute; bottom: 20px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 10px 15px; border-radius: 5px; font-size: 12px; font-family: monospace; max-height: 150px; overflow-y: auto; max-width: 400px; z-index: 100; pointer-events: auto; user-select: text;">
                        <div class="log-entry">Ready to load models...</div>
                    </div>
                </div>
            </main>

            <!-- Right Sidebar - I/O and Properties -->
            <aside class="sidebar sidebar-right">
                <!-- Ladder View Panels (shown when in ladder view) -->
                <div id="ladder-right-panels" style="display: none;">
                    <!-- Input Panel -->
                    <div class="io-panel">
                        <h2>Inputs</h2>
                        <div id="inputList" class="io-list">
                            <p class="empty-message">No inputs assigned</p>
                        </div>
                        <button id="addInput" class="btn btn-secondary btn-small">+ Add Input</button>
                    </div>

                    <!-- Feedback Panel -->
                    <div class="io-panel">
                        <h2>Feedbacks</h2>
                        <div id="feedbackList" class="io-list">
                            <p class="empty-message">No feedbacks available</p>
                        </div>
                    </div>

                    <!-- Output Panel -->
                    <div class="io-panel">
                        <h2>Outputs</h2>
                        <div id="outputList" class="io-list">
                            <p class="empty-message">No outputs assigned</p>
                        </div>
                        <button id="addOutput" class="btn btn-secondary btn-small">+ Add Output</button>
                    </div>

                    <!-- Properties Panel -->
                    <div class="properties-panel">
                        <h2>Properties</h2>
                        <div id="propertiesContent" class="properties-content">
                            <p class="empty-message">Select a component to view properties</p>
                        </div>
                    </div>
                </div>

                <!-- 3D Model View Panels (shown when in 3D model view) -->
                <div id="model-right-panels" style="display: none;">
                    <!-- Mounting Configuration -->
                    <div class="io-panel">
                        <h2>üìê Mounting Setup</h2>
                        <div style="padding: 10px;">
                            <label style="font-size: 11px; color: #888; display: block; margin-bottom: 5px;">Mounting Type:</label>
                            <select id="mountingType" style="width: 100%; padding: 5px; margin-bottom: 10px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                                <option value="box">Control Cabinet (Box)</option>
                                <option value="plate">Mounting Plate (Flat)</option>
                                <option value="shelf">Shelf (Open Front)</option>
                            </select>
                            
                            <label style="font-size: 11px; color: #888; display: block; margin-top: 10px;">Width (mm):</label>
                            <input type="number" id="mountingWidth" value="300" min="200" max="2000" step="50" style="width: 100%; padding: 5px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                            
                            <label style="font-size: 11px; color: #888; display: block; margin-top: 8px;">Height (mm):</label>
                            <input type="number" id="mountingHeight" value="200" min="200" max="2000" step="50" style="width: 100%; padding: 5px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                            
                            <label style="font-size: 11px; color: #888; display: block; margin-top: 8px;">Depth (mm):</label>
                            <input type="number" id="mountingDepth" value="200" min="100" max="1000" step="50" style="width: 100%; padding: 5px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                            
                            <button id="applyMounting" class="btn btn-success btn-small" style="margin-top: 10px; width: 100%;">Apply Changes</button>
                        </div>
                    </div>

                    <!-- View Mode Controls -->
                    <div class="io-panel">
                        <h2>üëÅÔ∏è View Mode</h2>
                        <div style="padding: 10px;">
                            <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                                <button id="view2D" class="btn btn-success btn-small" style="flex: 1; font-size: 11px;">üìê 2D Ortho</button>
                                <button id="view3D" class="btn btn-secondary btn-small" style="flex: 1; font-size: 11px;">üé≤ 3D Persp</button>
                            </div>
                            <p style="font-size: 10px; color: #888; margin: 0;">
                                <strong>2D Mode:</strong> Arrange items from top-down view (easier layout)<br>
                                <strong>3D Mode:</strong> View-only mode (use 2D to move objects)
                            </p>
                        </div>
                    </div>

                    <!-- Grid & Tools -->
                    <div class="io-panel">
                        <h2>üîß Grid & Tools</h2>
                        <div style="padding: 10px;">
                            <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                <input type="checkbox" id="toggleGrid" checked style="margin-right: 8px;">
                                <span>Show Grid</span>
                            </label>
                            <div style="margin-bottom: 10px;">
                                <label style="font-size: 11px; color: #888;">Grid Size (mm):</label>
                                <input type="range" id="gridSize" min="5" max="50" value="10" step="5" style="width: 100%;">
                                <span id="gridSizeValue" style="font-size: 11px; color: #888;">10mm</span>
                            </div>
                            <button id="toggleRuler" class="btn btn-secondary btn-small" style="width: 100%; margin-top: 10px;">
                                üìè Ruler: OFF
                            </button>
                            <p style="font-size: 10px; color: #888; margin: 5px 0 0 0;">
                                Click ruler, then click two points to measure distance
                            </p>
                        </div>
                    </div>

                    <!-- Physics Controls -->
                    <div class="io-panel">
                        <h2>‚öôÔ∏è Physics</h2>
                        <div style="padding: 10px;">
                            <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                <input type="checkbox" id="enableGravity" checked style="margin-right: 8px;">
                                <span>Enable Gravity</span>
                            </label>
                            <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                <input type="checkbox" id="enableSnapping" checked style="margin-right: 8px;">
                                <span>Snap to Surface</span>
                            </label>
                            <div style="margin-top: 10px;">
                                <label style="font-size: 11px; color: #888;">Snap Distance:</label>
                                <input type="range" id="snapDistance" min="5" max="200" value="20" style="width: 100%;">
                                <span id="snapDistanceValue" style="font-size: 11px; color: #888;">20mm</span>
                            </div>
                        </div>
                    </div>

                    <!-- Port Editor -->
                    <div class="io-panel">
                        <h2>üîå Connection Ports</h2>
                        <div style="padding: 10px;">
                            <div style="margin-bottom: 10px;">
                                <button id="togglePortEditMode" class="btn btn-secondary btn-small" style="width: 100%;">
                                    üìç Edit Ports Mode: OFF
                                </button>
                            </div>
                            <div id="portEditorControls" style="display: none;">
                                <p style="font-size: 10px; color: #888; margin: 5px 0;">
                                    Click on a model to add connection ports. Shift+Click to remove ports.
                                </p>
                                <div style="margin: 10px 0;">
                                    <label style="font-size: 11px; color: #888;">Port Label:</label>
                                    <input type="text" id="portLabel" placeholder="e.g., L1, N, IN1" style="width: 100%; padding: 5px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                                </div>
                                <div style="margin: 10px 0;">
                                    <label style="font-size: 11px; color: #888;">Port Type:</label>
                                    <select id="portType" style="width: 100%; padding: 5px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                                        <option value="power">‚ö° Power (L/N/PE)</option>
                                        <option value="input">üì• Input Signal</option>
                                        <option value="output">üì§ Output Signal</option>
                                        <option value="data">üíæ Data/Comm</option>
                                    </select>
                                </div>
                                <div style="margin: 10px 0;">
                                    <label style="font-size: 11px; color: #888;">Port Size (mm):</label>
                                    <input type="number" id="portSize" value="10" min="5" max="50" style="width: 100%; padding: 5px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                                </div>
                                <button id="savePortsToFile" class="btn btn-success btn-small" style="width: 100%; margin-top: 5px;">
                                    üíæ Export Port Config
                                </button>
                                <button id="loadPortsFromFile" class="btn btn-secondary btn-small" style="width: 100%; margin-top: 5px;">
                                    üìÅ Import Port Config
                                </button>
                            </div>
                            <div id="portsList" style="margin-top: 10px; font-size: 11px; max-height: 150px; overflow-y: auto;">
                                <p style="color: #888; font-size: 10px;">No ports defined</p>
                            </div>
                        </div>
                    </div>

                    <!-- Port Visibility Toggle -->
                    <div class="io-panel">
                        <h2>üëÅÔ∏è Port Visibility</h2>
                        <div style="padding: 10px;">
                            <button id="togglePortsVisibility" class="btn btn-secondary btn-small" style="width: 100%;">
                                üëÅÔ∏è Show Ports: ON
                            </button>
                            <p style="font-size: 10px; color: #888; margin-top: 5px;">
                                Toggle port markers and labels
                            </p>
                        </div>
                    </div>

                    <!-- 2D Wire Routing (EasyEDA-style) -->
                    <div class="io-panel" style="border: 2px solid #27ae60; box-shadow: 0 0 10px rgba(39, 174, 96, 0.3);">
                        <h2>üîå 2D Wire Routing</h2>
                        <div style="padding: 10px;">
                            <div style="background: #27ae60; padding: 6px; border-radius: 4px; margin-bottom: 10px; font-size: 11px; text-align: center;">
                                ‚úÖ <strong>NEW SYSTEM</strong> - Use This!
                            </div>
                            <div style="margin-bottom: 10px;">
                                <button id="toggle2DWireMode" class="btn btn-secondary btn-small" style="width: 100%;">
                                    üìê 2D Wire Mode: OFF
                                </button>
                            </div>
                            <div id="wire2DControls" style="display: none;">
                                <p style="font-size: 10px; color: #888; margin: 5px 0 10px 0;">
                                    Click port ‚Üí add corners ‚Üí SPACE to hang<br>
                                    ÔøΩÔ∏è Mouse wheel to zoom, Shift+Drag to pan<br>
                                    ÔøΩüí° Use view buttons below to rotate camera
                                </p>
                                <div style="margin-bottom: 10px;">
                                    <label style="font-size: 11px; color: #888; display: block; margin-bottom: 5px;">üé• Camera View (Rotates Scene):</label>
                                    <div style="display: flex; gap: 5px;">
                                        <button id="view-top" class="btn btn-info btn-small" style="flex: 1; padding: 5px; font-size: 11px;">
                                            ‚¨áÔ∏è Top
                                        </button>
                                        <button id="view-front" class="btn btn-info btn-small" style="flex: 1; padding: 5px; font-size: 11px;">
                                            üëÅÔ∏è Front
                                        </button>
                                        <button id="view-side" class="btn btn-info btn-small" style="flex: 1; padding: 5px; font-size: 11px;">
                                            ‚óÄÔ∏è Side
                                        </button>
                                    </div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label style="font-size: 11px; color: #888; display: block; margin-bottom: 5px;">Port Display Size:</label>
                                    <select id="wire-port-radius" style="width: 100%; padding: 5px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                                        <option value="4">Small (4px)</option>
                                        <option value="6" selected>Medium (6px)</option>
                                        <option value="8">Large (8px)</option>
                                        <option value="10">X-Large (10px)</option>
                                    </select>
                                </div>
                                <div style="display: flex; gap: 5px; margin-bottom: 10px;">
                                    <button id="toggle-wire-ports" class="btn btn-secondary btn-small" style="flex: 1; font-size: 11px;">
                                        üìç Ports
                                    </button>
                                    <button id="reset-wire-view" class="btn btn-secondary btn-small" style="flex: 1; font-size: 11px;">
                                        ÔøΩ Reset
                                    </button>
                                </div>
                                <p style="font-size: 10px; color: #888; margin: 5px 0;">
                                    üí° Grid controlled by View Controls panel
                                </p>
                                
                                <!-- Auto-Connect Settings -->
                                <div style="border-top: 1px solid #444; padding-top: 10px; margin: 10px 0;">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                        <label style="font-size: 11px; color: #888; font-weight: bold;">üîó Auto-Connect</label>
                                        <label class="switch" style="margin: 0;">
                                            <input type="checkbox" id="wire-auto-connect-enabled" checked>
                                            <span class="slider"></span>
                                        </label>
                                    </div>
                                    <div id="auto-connect-distance-container">
                                        <label style="font-size: 11px; color: #888; display: block; margin-bottom: 5px;">
                                            Snap Distance: <span id="auto-connect-distance-value">50</span>mm
                                        </label>
                                        <input type="range" id="wire-auto-connect-distance" min="5" max="100" value="50" step="5" 
                                               style="width: 100%; margin-bottom: 5px;">
                                        <div style="display: flex; justify-content: space-between; font-size: 9px; color: #666;">
                                            <span>5mm</span>
                                            <span>100mm</span>
                                        </div>
                                        <p style="font-size: 9px; color: #666; margin: 5px 0 0 0;">
                                            Wire preview turns yellow when near a port
                                        </p>
                                    </div>
                                </div>
                                
                                <button id="check-wire-status" class="btn btn-info btn-small" style="width: 100%; font-size: 11px; margin-bottom: 10px;">
                                    üîç Check Status
                                </button>
                                <button id="clear-all-2d-wires" class="btn btn-danger btn-small" style="width: 100%; font-size: 11px;">
                                    üóëÔ∏è Clear All Wires
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Object Properties -->
                    <div class="properties-panel">
                        <h2>üì¶ Selected Object</h2>
                        <div id="model-properties-content" class="properties-content">
                            <p class="empty-message">Select a component to view properties</p>
                        </div>
                    </div>

                    <!-- Scene Objects List -->
                    <div class="io-panel">
                        <h2>üóÇÔ∏è Scene Objects</h2>
                        <div id="scene-objects-list" style="padding: 5px; max-height: 150px; overflow-y: auto;">
                            <p class="empty-message">No objects in scene</p>
                        </div>
                        <button id="clearScene" class="btn btn-danger btn-small" style="margin-top: 10px;">Clear All</button>
                    </div>
                </div>

                <!-- Port Config View Panels (shown when in port config view) -->
                <div id="portconfig-right-panels" style="display: none;">
                    <!-- Current Model Info -->
                    <div class="io-panel">
                        <h2>‚ö° Port Management</h2>
                        <div id="portConfigCurrentModel" style="padding: 10px;">
                            <div style="font-size: 11px; color: #888; margin-bottom: 5px;">Current Model:</div>
                            <div id="portConfigModelName" style="font-size: 14px; color: #ecf0f1; font-weight: bold; margin-bottom: 10px;">None selected</div>
                            
                            <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #34495e;">
                                <label style="font-size: 11px; color: #888; display: block; margin-bottom: 5px;">Model Scale (for small OBJ):</label>
                                <div style="display: flex; gap: 5px; align-items: center;">
                                    <input type="number" id="portConfigScaleFactor" value="1" min="1" max="10000" step="100" 
                                           style="width: 80px; padding: 4px; background: #2c3e50; color: white; border: 1px solid #555; border-radius: 3px;">
                                    <button id="portConfigApplyScale" class="btn btn-info btn-small" style="flex: 1; padding: 4px 8px; font-size: 11px;">
                                        Apply
                                    </button>
                                </div>
                                <div style="font-size: 9px; color: #7f8c8d; margin-top: 3px;">1000 = meters‚Üímm, 100 = cm‚Üímm</div>
                            </div>
                        </div>
                    </div>

                    <!-- Clear Controls -->
                    <div class="io-panel">
                        <h2>üóëÔ∏è Clear</h2>
                        <div style="padding: 10px;">
                            <button id="portConfigClearDots" class="btn btn-warning btn-small" style="width: 100%; margin-bottom: 8px;">
                                Clear Dots
                            </button>
                            <button id="portConfigClearPorts" class="btn btn-danger btn-small" style="width: 100%;">
                                Clear All Ports
                            </button>
                        </div>
                    </div>

                    <!-- Save/Load -->
                    <div class="io-panel">
                        <h2>üíæ Save/Load</h2>
                        <div style="padding: 10px;">
                            <button id="portConfigSavePorts" class="btn btn-info btn-small" style="width: 100%; margin-bottom: 8px;">
                                Save Port Config
                            </button>
                            <button id="portConfigLoadPorts" class="btn btn-secondary btn-small" style="width: 100%;">
                                Load Port Config
                            </button>
                        </div>
                    </div>

                    <!-- Configured Ports List -->
                    <div class="io-panel" id="portConfigPortsList">
                        <h2>üìç Configured Ports</h2>
                        <div id="portConfigPortsContent" style="padding: 10px; max-height: 300px; overflow-y: auto;">
                            <p style="color: #888; font-size: 12px;">No ports configured</p>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- Modal for Pin Assignment -->
    <div id="pinModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalTitle">Assign Pin</h2>
            <form id="pinAssignmentForm">
                <div class="form-group">
                    <label for="pinNumber">Pin:</label>
                    <select id="pinNumber" required>
                        <option value="">Select pin...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="pinLabel">Label:</label>
                    <input type="text" id="pinLabel" placeholder="e.g., Start Button" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Assign</button>
                    <button type="button" class="btn btn-secondary" id="cancelPin">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Timer Configuration -->
    <div id="timerModal" class="modal">
        <div class="modal-content">
            <span class="close-timer">&times;</span>
            <h2 id="timerModalTitle">Configure Timer</h2>
            <form id="timerConfigForm">
                <div class="form-group">
                    <label for="timerLabel">Label:</label>
                    <input type="text" id="timerLabel" placeholder="e.g., Delay Start" required>
                </div>
                <div class="form-group">
                    <label for="timerPreset">Preset Time (seconds):</label>
                    <input type="number" id="timerPreset" min="0.1" max="3600" step="0.1" value="1.0" required>
                </div>
                <div class="form-group">
                    <label>Timer Type:</label>
                    <p id="timerTypeDisplay" style="color: #9C27B0; font-weight: bold;">TON - On Delay</p>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">Save</button>
                    <button type="button" class="btn btn-secondary" id="cancelTimer">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for Libraries -->
    <div id="librariesModal" class="modal">
        <div class="modal-content">
            <span class="close-libraries">&times;</span>
            <h2>Example Circuit Libraries</h2>
            <div class="library-container">
                <p>Load a pre-built circuit example:</p>
                <div id="libraryList" class="library-list">
                    <button class="library-item" data-library="simple-on-off">
                        <strong>Simple ON/OFF Circuit</strong>
                        <p>Basic start/stop control with one input and one output</p>
                    </button>
                    <button class="library-item" data-library="and-circuit">
                        <strong>AND Circuit</strong>
                        <p>Two inputs in series (both must be ON)</p>
                    </button>
                    <button class="library-item" data-library="or-circuit">
                        <strong>OR Circuit</strong>
                        <p>Two inputs in parallel (either can be ON)</p>
                    </button>
                    <button class="library-item" data-library="complex-and-or">
                        <strong>Complex AND/OR Circuit</strong>
                        <p>Combination of series and parallel logic</p>
                    </button>
                    <button class="library-item" data-library="latch-circuit">
                        <strong>Latch Circuit</strong>
                        <p>Start/stop with feedback latching</p>
                    </button>
                    <button class="library-item" data-library="timer-circuit">
                        <strong>Timer Circuit</strong>
                        <p>Delayed output using TON timer</p>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Analysis Library -->
    <script src="analysis-v2.js"></script>
    
    <!-- Three.js Library (for 3D viewer) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/STLLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/OBJLoader.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/loaders/MTLLoader.js"></script>
    
    <!-- Rapier Physics Engine -->
    <script src="https://cdn.jsdelivr.net/npm/@dimforge/rapier3d-compat@0.11.2/rapier.min.js"></script>
    
    <!-- PLC Simulator Modules (Load order is important!) -->
    <!-- 1. Configuration & Constants -->
    <script src="js/ladder/config.js"></script>
    
    <!-- 2. State Management -->
    <script src="js/ladder/state.js"></script>
    
    <!-- 3. DOM References -->
    <script src="js/ladder/dom.js"></script>
    
    <!-- 4. Utility Functions -->
    <script src="js/ladder/canvas.js"></script>
    <script src="js/ladder/keyboard.js"></script>
    
    <!-- 5. Core Features -->
    <script src="js/ladder/components.js"></script>
    <script src="js/ladder/modals.js"></script>
    <script src="js/ladder/rendering.js"></script>
    <script src="js/ladder/ui.js"></script>
    <script src="js/ladder/simulation.js"></script>
    <script src="js/ladder/diagram.js"></script>
    
    <!-- 6. Initialization -->
    <script src="js/ladder/init.js"></script>
    
    <!-- 7. Entry Point -->
    <script src="js/ladder/main.js"></script>
    
    <!-- 2D Drawing System -->
    <script src="js/drawing/canvas.js"></script>
    <script src="js/drawing/init.js"></script>
    
    <!-- 3D Wire Routing in 2D Canvas (EasyEDA-style) -->
    <script src="js/drawing/viewManager.js"></script>
    <script src="js/drawing/gridSystem.js"></script>
    <script src="js/drawing/wireRouting.js"></script>
    <script src="js/drawing/wireRoutingInit.js"></script>
    
    <!-- View Toggle Controls -->
    <script src="js/shared/viewSwitching.js"></script>
    
    <!-- 3D Model System - Modular Files -->
    <script src="js/model/modelScene.js"></script>
    <script src="js/model/modelPhysics.js"></script>
    <script src="js/model/modelLoader.js"></script>
    <script src="js/model/modelPorts.js"></script>
    <script src="js/model/modelWiring.js"></script>
    <script src="js/model/modelWiring3D.js"></script>
    <script src="js/model/modelTools.js"></script>
    <script src="js/model/modelStorage.js"></script>
    
    <!-- Port Config Viewer - Modular Files -->
    <script src="js/port/portConfigScene.js"></script>
    <script src="js/port/portConfigLoader.js"></script>
    <script src="js/port/portConfigMarkers.js"></script>
    <script src="js/port/portConfigUI.js"></script>
    <script src="js/port/portConfigStorage.js"></script>
    <script src="js/port/portConfigInteraction.js"></script>
    <script src="js/port/portConfigViewer.js"></script>
    <script src="js/port/portConfigInit.js"></script>
    
    <!-- 3D Model Viewer Script -->
    <script>
        // Interactive 3D Scene Manager with Physics (using modular classes)
        class Interactive3DScene {
            constructor(container, statusDiv) {
                this.container = container;
                this.statusDiv = statusDiv;
                
                // Initialize manager instances
                this.sceneManager = new ModelSceneManager();
                this.physicsManager = new ModelPhysicsManager();
                this.loaderManager = new ModelLoaderManager();
                this.portsManager = new ModelPortsManager();
                this.wiringManager = new ModelWiringManager();
                this.toolsManager = new ModelToolsManager();
                this.storageManager = new ModelStorageManager();
                
                // Initialize state properties
                this.scene = null;
                this.camera = null;
                this.renderer = null;
                this.orbitControls = null;
                this.transformControls = null;
                this.world = null;
                this.rigidBodies = new Map();
                this.sceneObjects = [];
                this.selectedObject = null;
                this.snapEnabled = true;
                this.snapDistance = 20;
                this.gravityEnabled = true;
                this.mountingSurfaces = [];
                this.boundaryWalls = [];
                this.viewMode = '2d';
                this.currentView = 'top'; // Track current orthographic view for wire routing
                this.interactionEnabled = true;
                
                this.mountingConfig = {
                    type: 'box',
                    width: 300,
                    height: 200,
                    depth: 200
                };
                
                this.gridHelper = null;
                this.gridVisible = true; // Show 3D mounting grids
                this.gridSize = 20;
                this.mountingGridSize = 10; // 3D mounting grid size in mm
                
                this.rulerMode = false;
                this.portEditMode = false;
                this.modelPorts = new Map();
                this.portMarkers = [];
                this.portsVisible = true; // Ports visible by default
                
                this.wireMode = false;
                this.wiring3DManager = new ModelWiring3DManager(); // New 3D wire system
                
                this.collisionMeshes = new Map();
                
                // Object instance counter for unique IDs
                this.objectInstanceCounter = 0;
                
                this.init();
            }
            
            async init() {
                // Delegate to scene manager
                const sceneSetup = this.sceneManager.setupScene(this.container, this.statusDiv);
                this.scene = sceneSetup.scene;
                this.perspectiveCamera = sceneSetup.perspectiveCamera;
                this.orthographicCamera = sceneSetup.orthographicCamera;
                this.camera = sceneSetup.camera;
                this.renderer = sceneSetup.renderer;
                this.is2DMode = sceneSetup.is2DMode;
                
                this.sceneManager.setupLighting(this.scene);
                
                const controls = this.sceneManager.setupControls(this, this.camera, this.renderer, this.scene);
                this.orbitControls = controls.orbitControls;
                this.transformControls = controls.transformControls;
                
                const viewCube = this.sceneManager.setupViewCube(this);
                if (viewCube) {
                    this.viewCubeScene = viewCube.viewCubeScene;
                    this.viewCubeCamera = viewCube.viewCubeCamera;
                    this.viewCubeRenderer = viewCube.viewCubeRenderer;
                    this.viewCubeMesh = viewCube.viewCubeMesh;
                }
                
                this.sceneManager.setupMousePicking(this, this.renderer, this.camera, this.transformControls);
                
                await this.physicsManager.setupPhysics(this);
                this.physicsManager.createMounting(this);
                this.animate();
                this.log('‚úÖ Interactive 3D Scene initialized', 'success');
            }
            
            // All methods now delegate to respective managers
            animate() {
                requestAnimationFrame(() => this.animate());
                if (this.world) {
                    this.world.step();
                    this.sceneObjects.forEach(obj => {
                        const body = this.rigidBodies.get(obj);
                        if (body) {
                            const isDragging = this.selectedObject === obj && this.transformControls.dragging;
                            if (isDragging) {
                                body.setTranslation(obj.position, true);
                                body.setRotation(obj.quaternion, true);
                                body.setLinvel({ x: 0, y: 0, z: 0 }, true);
                                body.setAngvel({ x: 0, y: 0, z: 0 }, true);
                            } else {
                                const position = body.translation();
                                obj.position.set(position.x, position.y, position.z);
                                const rotation = body.rotation();
                                obj.quaternion.set(rotation.x, rotation.y, rotation.z, rotation.w);
                            }
                            this.physicsManager.enforceObjectBoundaries(this, obj);
                        }
                    });
                }
                this.orbitControls.update();
                this.renderer.render(this.scene, this.camera);
                if (this.viewCubeRenderer) {
                    this.sceneManager.renderViewCube(this.viewCubeMesh, this.viewCubeRenderer, this.viewCubeScene, this.viewCubeCamera, this.camera);
                }
                this.toolsManager.checkCollisions(this);
            }
            
            // Scene management delegates
            setupControls() { /* Handled by sceneManager in init */ }
            setupMousePicking() { /* Handled by sceneManager */ }
            setupViewCube() { /* Handled by sceneManager */ }
            renderViewCube() { this.sceneManager.renderViewCube(this.viewCubeMesh, this.viewCubeRenderer, this.viewCubeScene, this.viewCubeCamera, this.camera); }
            setView(viewName) { this.sceneManager.setView(this, viewName); }
            animateCamera(targetPos, targetLookAt) { this.sceneManager.animateCamera(this, targetPos, targetLookAt); }
            switchTo2DView() { this.sceneManager.switchTo2DView(this); }
            switchTo3DView() { this.sceneManager.switchTo3DView(this); }
            selectObject(obj) { this.sceneManager.selectObject(this, obj); }
            deselectObject() { this.sceneManager.deselectObject(this); }
            updatePropertiesPanel() { this.sceneManager.updatePropertiesPanel(this); }
            updateSceneObjectsList() { this.sceneManager.updateSceneObjectsList(this); }
            deleteSelected() { this.sceneManager.deleteSelected(this); }
            clearScene() { this.sceneManager.clearScene(this); }
            
            // Physics delegates
            setupPhysics() { return this.physicsManager.setupPhysics(this); }
            createMounting() { this.physicsManager.createMounting(this); }
            rebuildMounting() { this.physicsManager.rebuildMounting(this); }
            addPhysicsBody(mesh, geometry) { this.physicsManager.addPhysicsBody(this, mesh, geometry); }
            addPhysicsBodyFromBBox(object, size) { this.physicsManager.addPhysicsBodyFromBBox(this, object, size); }
            updatePhysicsBody(mesh) { this.physicsManager.updatePhysicsBody(this, mesh); }
            enforceObjectBoundaries(obj) { this.physicsManager.enforceObjectBoundaries(this, obj); }
            checkSnapping(mesh) { this.physicsManager.checkSnapping(this, mesh); }
            
            // Loader delegates
            loadSTL(file, name, modelData) { return this.loaderManager.loadSTL(this, file, name, modelData); }
            loadOBJ(objFile, mtlFile, name, modelData) { return this.loaderManager.loadOBJ(this, objFile, mtlFile, name, modelData); }
            uploadSTLFile() { this.loaderManager.uploadSTLFile(this); }
            uploadOBJFile() { this.loaderManager.uploadOBJFile(this); }
            loadCustomModel(modelId) { return this.loaderManager.loadCustomModel(this, modelId); }
            deleteCustomModel(modelId) { this.loaderManager.deleteCustomModel(this, modelId); }
            refreshCustomModelsList() { this.loaderManager.refreshCustomModelsList(this); }
            
            // Ports delegates
            togglePortEditMode() { this.portsManager.togglePortEditMode(this); }
            addPortToModel(modelObj, worldPosition, shiftKey) { this.portsManager.addPortToModel(this, modelObj, worldPosition, shiftKey); }
            updatePortMarkers() { this.portsManager.updatePortMarkers(this); }
            updatePortsList() { this.portsManager.updatePortsList(this); }
            exportPortsConfig() { this.portsManager.exportPortsConfig(this); }
            importPortsConfig(file) { this.portsManager.importPortsConfig(this, file); }
            clearPortMarkers() { this.portsManager.clearPortMarkers(this); }
            setPortVisualScale(scale) { this.portsManager.setPortVisualScale(this, scale); }
            
            // Wiring delegates
            toggleWireMode() { this.wiringManager.toggleWireMode(this); }
            handlePortClickForWiring(port, portMarker) { this.wiringManager.handlePortClickForWiring(this, port, portMarker); }
            createWire(portA, portB, wireType, wireGauge) { this.wiringManager.createWire(this, portA, portB, wireType, wireGauge); }
            updateWiresList() { this.wiringManager.updateWiresList(this); }
            deleteWire(wireId) { this.wiringManager.deleteWire(this, wireId); }
            clearAllWires() { 
                this.wiringManager.clearAllWires(this); 
                if (this.wiring3DManager) {
                    this.wiring3DManager.clearAllWires(this);
                }
            }
            exportWireList() { this.wiringManager.exportWireList(this); }
            
            // Tools delegates
            toggleRuler() { this.toolsManager.toggleRuler(this); }
            handleRulerClick(raycaster, mouse) { this.toolsManager.handleRulerClick(this, raycaster, mouse); }
            clearRuler() { this.toolsManager.clearRuler(this); }
            updateGrid() { this.toolsManager.updateGrid(this); }
            toggleGrid() { this.toolsManager.toggleGrid(this); }
            setGridSize(divisions) { this.toolsManager.setGridSize(this, divisions); }
            checkCollisions() { this.toolsManager.checkCollisions(this); }
            
            // Storage delegates
            save3DLayout() { this.storageManager.save3DLayout(this); }
            load3DLayout() { this.storageManager.load3DLayout(this); }
            
            // Logging method
            log(message, type = 'info') {
                const entry = document.createElement('div');
                entry.className = 'log-entry';
                entry.style.color = type === 'success' ? '#2ecc71' :
                                   type === 'error' ? '#e74c3c' :
                                   type === 'warning' ? '#f39c12' : '#3498db';
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
                this.statusDiv.appendChild(entry);
                this.statusDiv.scrollTop = this.statusDiv.scrollHeight;
                
                // Keep only last 20 messages
                while (this.statusDiv.children.length > 20) {
                    this.statusDiv.removeChild(this.statusDiv.firstChild);
                }
            }
        }
        
        // Initialize Interactive 3D Scene
        let viewer3D = null;
        const catalog = new STLModelCatalog();
        
        function init3DViewer() {
            if (viewer3D) return; // Already initialized
            
            const container = document.getElementById('model-viewer-container');
            const statusDiv = document.getElementById('model-viewer-status');
            
            viewer3D = new Interactive3DScene(container, statusDiv);
            window.viewer3D = viewer3D; // Make globally accessible
            
            // Setup physics controls
            setupPhysicsControls();
            
            // Setup view mode controls
            setupViewModeControls();
            
            // Setup 3D layout save/load buttons
            setup3DLayoutControls();
            
            // Initialize 3D wire routing system
            if (typeof initWireRouting3D === 'function') {
                initWireRouting3D();
            }
            
            // Ensure we start in proper 2D mode with rotation DISABLED
            // User must choose view via buttons (Top/Front/Side)
            if (viewer3D.orbitControls) {
                viewer3D.orbitControls.enableRotate = false;
                viewer3D.orbitControls.enablePan = true;
                viewer3D.orbitControls.enableZoom = true;
            }
            
            // Setup keyboard shortcuts for wire routing
            setupWireKeyboardShortcuts();
            
            console.log('‚úÖ 3D Viewer initialized in 2D Orthographic mode with rotation enabled');
        }
        
        function setupWireKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Check wire mode status
                if (!window.viewer3D || !window.viewer3D.wireMode) {
                    return;
                }
                
                if (e.key === 'Escape') {
                    // Cancel current wire
                    if (window.viewer3D.wiring3DManager.currentWire) {
                        window.viewer3D.wiring3DManager.cancelWire(window.viewer3D);
                    }
                }
                
                // Handle SPACE key to hang wire (leave wire open-ended)
                if (e.key === ' ' || e.key === 'Spacebar') {
                    e.preventDefault(); // Prevent page scroll
                    if (window.viewer3D.wiring3DManager.currentWire) {
                        window.viewer3D.wiring3DManager.hangWire(window.viewer3D);
                    }
                }
                
                // Handle Ctrl+Z for undo (Mac uses Cmd+Z, which is metaKey)
                if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    console.log('üîÑ Undo shortcut detected');
                    if (window.viewer3D.wiring3DManager) {
                        const success = window.viewer3D.wiring3DManager.undo(window.viewer3D);
                        if (!success) {
                            console.log('‚ö†Ô∏è Undo failed - check history');
                        }
                    }
                }
                
                // Handle Ctrl+Y for redo (also support Ctrl+Shift+Z)
                if (((e.ctrlKey || e.metaKey) && e.key === 'y') || 
                    ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'z')) {
                    e.preventDefault();
                    console.log('üîÑ Redo shortcut detected');
                    if (window.viewer3D.wiring3DManager) {
                        const success = window.viewer3D.wiring3DManager.redo(window.viewer3D);
                        if (!success) {
                            console.log('‚ö†Ô∏è Redo failed - check history');
                        }
                    }
                }
            });
        }
        
        function setup3DLayoutControls() {
            const save3DBtn = document.getElementById('save3DLayout');
            const load3DBtn = document.getElementById('load3DLayout');
            const clear3DBtn = document.getElementById('clear3DLayout');
            
            if (save3DBtn) {
                save3DBtn.addEventListener('click', () => {
                    console.log('Save button clicked, viewer3D:', window.viewer3D);
                    if (window.viewer3D) {
                        window.viewer3D.save3DLayout();
                    } else {
                        console.error('viewer3D not initialized');
                    }
                });
            }
            
            if (load3DBtn) {
                load3DBtn.addEventListener('click', () => {
                    console.log('Load button clicked, viewer3D:', window.viewer3D);
                    if (window.viewer3D) {
                        window.viewer3D.load3DLayout();
                    } else {
                        console.error('viewer3D not initialized');
                    }
                });
            }
            
            if (clear3DBtn) {
                clear3DBtn.addEventListener('click', () => {
                    console.log('Clear button clicked, viewer3D:', window.viewer3D);
                    if (window.viewer3D) {
                        if (confirm('Are you sure you want to clear the entire scene?')) {
                            window.viewer3D.clearScene();
                        }
                    } else {
                        console.error('viewer3D not initialized');
                    }
                });
            }
            
            console.log('3D Layout controls initialized');
        }
        
        function setupViewModeControls() {
            const view2DBtn = document.getElementById('view2D');
            const view3DBtn = document.getElementById('view3D');
            
            if (view2DBtn && view3DBtn) {
                // Start in 2D mode (button already highlighted)
                view2DBtn.classList.add('btn-success');
                view2DBtn.classList.remove('btn-secondary');
                view3DBtn.classList.remove('btn-success');
                view3DBtn.classList.add('btn-secondary');
                
                // Initialize the view to top view on first load
                if (viewer3D) {
                    viewer3D.setView('top');
                    if (window.wireRouting3D) {
                        window.wireRouting3D.setView('top');
                    }
                    console.log('‚úÖ Initial view set to top view');
                }
                
                view2DBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.switchTo2DView();
                        // Re-enable rotation so view plane buttons work
                        if (viewer3D.orbitControls) {
                            viewer3D.orbitControls.enableRotate = true;
                        }
                        // Set to top view to ensure grid is created correctly
                        viewer3D.setView('top');
                        // Also update wire routing if active
                        if (window.wireRouting3D) {
                            window.wireRouting3D.setView('top');
                        }
                        view2DBtn.classList.add('btn-success');
                        view2DBtn.classList.remove('btn-secondary');
                        view3DBtn.classList.remove('btn-success');
                        view3DBtn.classList.add('btn-secondary');
                        console.log('‚úÖ 2D Mode: Orthographic camera with top view');
                    }
                });
                
                view3DBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        // Disable 2D wire mode when switching to 3D
                        if (window.wireRouting3D && window.wireRouting3D.enabled) {
                            window.wireRouting3D.disable();
                            const toggle2DWireBtn = document.getElementById('toggle2DWireMode');
                            if (toggle2DWireBtn) {
                                toggle2DWireBtn.textContent = 'üìê 2D Wire Mode: OFF';
                                toggle2DWireBtn.style.background = '#34495e';
                            }
                            const wire2DControls = document.getElementById('wire2DControls');
                            if (wire2DControls) wire2DControls.style.display = 'none';
                            console.log('‚ö†Ô∏è 2D Wire Mode disabled (3D view active)');
                        }
                        
                        viewer3D.switchTo3DView();
                        view3DBtn.classList.add('btn-success');
                        view3DBtn.classList.remove('btn-secondary');
                        view2DBtn.classList.remove('btn-success');
                        view2DBtn.classList.add('btn-secondary');
                        console.log('‚úÖ 3D Mode: Perspective camera with full rotation');
                    }
                });
            }
        }
        
        function setupPhysicsControls() {
            // Mounting configuration controls
            const mountingType = document.getElementById('mountingType');
            const mountingWidth = document.getElementById('mountingWidth');
            const mountingHeight = document.getElementById('mountingHeight');
            const mountingDepth = document.getElementById('mountingDepth');
            const applyMountingBtn = document.getElementById('applyMounting');
            
            if (applyMountingBtn) {
                applyMountingBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.mountingConfig.type = mountingType.value;
                        viewer3D.mountingConfig.width = parseFloat(mountingWidth.value);
                        viewer3D.mountingConfig.height = parseFloat(mountingHeight.value);
                        viewer3D.mountingConfig.depth = parseFloat(mountingDepth.value);
                        viewer3D.rebuildMounting();
                    }
                });
            }
            
            // Physics controls
            const gravityCheckbox = document.getElementById('enableGravity');
            const snappingCheckbox = document.getElementById('enableSnapping');
            const snapDistanceSlider = document.getElementById('snapDistance');
            const snapDistanceValue = document.getElementById('snapDistanceValue');
            const clearSceneBtn = document.getElementById('clearScene');
            
            if (gravityCheckbox) {
                gravityCheckbox.addEventListener('change', (e) => {
                    if (viewer3D) {
                        viewer3D.gravityEnabled = e.target.checked;
                        viewer3D.log(`‚öôÔ∏è Gravity ${e.target.checked ? 'enabled' : 'disabled'}`, 'info');
                    }
                });
            }
            
            if (snappingCheckbox) {
                snappingCheckbox.addEventListener('change', (e) => {
                    if (viewer3D) {
                        viewer3D.snapEnabled = e.target.checked;
                        viewer3D.log(`üß≤ Snapping ${e.target.checked ? 'enabled' : 'disabled'}`, 'info');
                    }
                });
            }
            
            if (snapDistanceSlider) {
                snapDistanceSlider.addEventListener('input', (e) => {
                    if (viewer3D) {
                        viewer3D.snapDistance = parseFloat(e.target.value);
                        snapDistanceValue.textContent = `${e.target.value}mm`;
                    }
                });
            }
            
            // Grid controls
            const toggleGridCheckbox = document.getElementById('toggleGrid');
            const gridSizeSlider = document.getElementById('gridSize');
            const gridSizeValue = document.getElementById('gridSizeValue');
            
            if (toggleGridCheckbox) {
                toggleGridCheckbox.addEventListener('change', (e) => {
                    if (viewer3D) {
                        viewer3D.toggleGrid();
                    }
                });
            }
            
            if (gridSizeSlider) {
                gridSizeSlider.addEventListener('input', (e) => {
                    if (viewer3D) {
                        viewer3D.setGridSize(parseInt(e.target.value));
                        gridSizeValue.textContent = e.target.value + 'mm';
                    }
                });
            }
            
            // Ruler control
            const toggleRulerBtn = document.getElementById('toggleRuler');
            
            if (toggleRulerBtn) {
                toggleRulerBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.toggleRuler();
                        const isOn = viewer3D.rulerMode;
                        toggleRulerBtn.textContent = `üìè Ruler: ${isOn ? 'ON' : 'OFF'}`;
                        toggleRulerBtn.classList.toggle('btn-success', isOn);
                        toggleRulerBtn.classList.toggle('btn-secondary', !isOn);
                    }
                });
            }
            
            // Port Editor controls
            const togglePortEditBtn = document.getElementById('togglePortEditMode');
            const savePortsBtn = document.getElementById('savePortsToFile');
            const loadPortsBtn = document.getElementById('loadPortsFromFile');
            
            if (togglePortEditBtn) {
                togglePortEditBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.togglePortEditMode();
                    }
                });
            }
            
            if (savePortsBtn) {
                savePortsBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.exportPortsConfig();
                    }
                });
            }
            
            if (loadPortsBtn) {
                loadPortsBtn.addEventListener('click', () => {
                    const input = document.createElement('input');
                    input.type = 'file';
                    input.accept = '.json';
                    input.onchange = (e) => {
                        const file = e.target.files[0];
                        if (file && viewer3D) {
                            viewer3D.importPortsConfig(file);
                        }
                    };
                    input.click();
                });
            }
            
            if (clearSceneBtn) {
                clearSceneBtn.addEventListener('click', () => {
                    if (viewer3D && confirm('Clear all objects from scene?')) {
                        viewer3D.clearScene();
                    }
                });
            }
        }
        
        // Load model catalog and create buttons
        async function loadModelButtons() {
            try {
                const models = await catalog.loadCatalog();
                const container = document.getElementById('model-list-buttons');
                const infoText = document.getElementById('model-catalog-info');
                
                container.innerHTML = '';
                
                models.forEach((model) => {
                    const button = document.createElement('button');
                    button.className = 'btn btn-success btn-block';
                    button.style.cssText = 'margin-bottom: 8px; text-align: left; padding: 10px;';
                    
                    // Show format indicator
                    const formatIcon = model.format === 'obj' ? 'üé®' : 'üì¶';
                    const formatText = model.format === 'obj' ? 'OBJ+MTL' : 'STL';
                    
                    button.innerHTML = `
                        <div style="font-weight: bold; margin-bottom: 3px;">${formatIcon} ${model.name}</div>
                        <div style="font-size: 10px; opacity: 0.8;">${model.size} ‚Ä¢ ${formatText}</div>
                    `;
                    button.onclick = () => {
                        if (viewer3D) {
                            if (model.format === 'obj') {
                                // Load OBJ+MTL
                                // Check if URL is absolute (starts with http/https) or relative
                                const objPath = model.file.startsWith('http') ? model.file : `libs/model/${model.file}`;
                                const mtlPath = model.mtlFile.startsWith('http') ? model.mtlFile : `libs/model/${model.mtlFile}`;
                                viewer3D.loadOBJ(objPath, mtlPath, model.name, model);
                            } else {
                                // Load STL
                                // Check if URL is absolute (starts with http/https) or relative
                                const filePath = model.file.startsWith('http') ? model.file : `libs/model/${model.file}`;
                                viewer3D.loadSTL(filePath, model.name, model);
                            }
                        }
                    };
                    container.appendChild(button);
                });
                
                infoText.textContent = `‚úÖ ${models.length} CAD models available - Click to add to scene`;
                infoText.style.color = '#2ecc71';
                
            } catch (error) {
                console.error('Failed to load model catalog:', error);
            }
        }
        
        function setupCustomModelUpload() {
            const uploadSTLBtn = document.getElementById('uploadSTL');
            const uploadOBJBtn = document.getElementById('uploadOBJ');
            
            if (uploadSTLBtn) {
                uploadSTLBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.uploadSTLFile();
                    }
                });
            }
            
            if (uploadOBJBtn) {
                uploadOBJBtn.addEventListener('click', () => {
                    if (viewer3D) {
                        viewer3D.uploadOBJFile();
                    }
                });
            }
            
            // Load existing custom models
            if (viewer3D) {
                viewer3D.refreshCustomModelsList();
            }
        }
        
        // Track if port visibility toggle is already set up
        let portVisibilityInitialized = false;
        
        function setupPortVisibilityToggle() {
            if (portVisibilityInitialized) return; // Already initialized
            portVisibilityInitialized = true;
            
            const togglePortsBtn = document.getElementById('togglePortsVisibility');
            
            if (togglePortsBtn) {
                togglePortsBtn.addEventListener('click', () => {
                    if (viewer3D && viewer3D.portsManager) {
                        // Toggle state
                        const newState = !viewer3D.portsVisible;
                        viewer3D.portsManager.togglePortsVisibility(viewer3D, newState);
                        
                        // Update button
                        togglePortsBtn.textContent = newState ? 'üëÅÔ∏è Show Ports: ON' : 'üôà Show Ports: OFF';
                        togglePortsBtn.style.background = newState ? '#27ae60' : '#34495e';
                    }
                });
            }
        }
        
        // Track if wire system is already set up to prevent duplicate listeners
        let wireSystemInitialized = false;
        
        // OLD WIRE SYSTEM - REMOVED (UI elements deleted)
        // function setupWireSystem() {
        //     ... old wire mode code removed ...
        // }
        
        // Setup 2D Wire Routing controls
        function setup2DWireRoutingControls() {
            const toggle2DWireBtn = document.getElementById('toggle2DWireMode');
            const wire2DControls = document.getElementById('wire2DControls');
            
                if (toggle2DWireBtn) {
                toggle2DWireBtn.addEventListener('click', () => {
                    if (!window.viewer3D || !window.viewer3D.wiring3DManager) {
                        console.warn('3D Wire Manager not initialized yet');
                        return;
                    }
                    
                    const isEnabled = window.viewer3D.wireMode;
                    
                    if (isEnabled) {
                        // Disable 3D wire mode
                        window.viewer3D.wiring3DManager.disableWireMode(window.viewer3D);
                        toggle2DWireBtn.textContent = 'üìê 2D Wire Mode: OFF';
                        toggle2DWireBtn.style.background = '#34495e';
                        if (wire2DControls) wire2DControls.style.display = 'none';
                    } else {
                        // Auto-activate 2D orthographic view for wire routing
                        window.viewer3D.switchTo2DView();
                        window.viewer3D.setView('top');
                        console.log('‚úÖ Auto-switched to 2D orthographic top view for wire routing');
                        
                        // Update view mode buttons
                        const view2DBtn = document.getElementById('view2D');
                        const view3DBtn = document.getElementById('view3D');
                        if (view2DBtn && view3DBtn) {
                            view2DBtn.classList.add('btn-success');
                            view2DBtn.classList.remove('btn-secondary');
                            view3DBtn.classList.remove('btn-success');
                            view3DBtn.classList.add('btn-secondary');
                        }
                        
                        // Enable 3D wire mode
                        window.viewer3D.wiring3DManager.enableWireMode(window.viewer3D);
                        toggle2DWireBtn.textContent = '‚úÖ 2D Wire Mode: ON';
                        toggle2DWireBtn.style.background = '#27ae60';
                        if (wire2DControls) wire2DControls.style.display = 'block';
                    }
                });
            }            // View switching buttons with active state
            const viewButtons = {
                'view-top': 'top',
                'view-front': 'front',
                'view-side': 'side-left'
            };
            
            function updateViewButtons(activeView) {
                Object.keys(viewButtons).forEach(btnId => {
                    const btn = document.getElementById(btnId);
                    if (btn) {
                        if (viewButtons[btnId] === activeView) {
                            btn.style.background = '#27ae60';
                            btn.style.color = 'white';
                        } else {
                            btn.style.background = '';
                            btn.style.color = '';
                        }
                    }
                });
            }
            
            document.getElementById('view-top')?.addEventListener('click', () => {
                console.log('Top view button clicked');
                // Switch to 2D orthographic mode
                if (window.viewer3D) {
                    if (!window.viewer3D.is2DMode) {
                        window.viewer3D.switchTo2DView();
                        // Update view mode button states
                        const view2DBtn = document.getElementById('view2D');
                        const view3DBtn = document.getElementById('view3D');
                        if (view2DBtn && view3DBtn) {
                            view2DBtn.classList.add('btn-success');
                            view2DBtn.classList.remove('btn-secondary');
                            view3DBtn.classList.remove('btn-success');
                            view3DBtn.classList.add('btn-secondary');
                        }
                    }
                    window.viewer3D.setView('top');
                }
                // Change 2D wire routing projection
                if (window.wireRouting3D) {
                    window.wireRouting3D.setView('top');
                }
                updateViewButtons('top');
            });
            
            document.getElementById('view-front')?.addEventListener('click', () => {
                console.log('Front view button clicked');
                // Switch to 2D orthographic mode
                if (window.viewer3D) {
                    if (!window.viewer3D.is2DMode) {
                        window.viewer3D.switchTo2DView();
                        // Update view mode button states
                        const view2DBtn = document.getElementById('view2D');
                        const view3DBtn = document.getElementById('view3D');
                        if (view2DBtn && view3DBtn) {
                            view2DBtn.classList.add('btn-success');
                            view2DBtn.classList.remove('btn-secondary');
                            view3DBtn.classList.remove('btn-success');
                            view3DBtn.classList.add('btn-secondary');
                        }
                    }
                    window.viewer3D.setView('front');
                }
                // Change 2D wire routing projection
                if (window.wireRouting3D) {
                    window.wireRouting3D.setView('front');
                }
                updateViewButtons('front');
            });
            
            document.getElementById('view-side')?.addEventListener('click', () => {
                console.log('Side view button clicked');
                // Switch to 2D orthographic mode
                if (window.viewer3D) {
                    if (!window.viewer3D.is2DMode) {
                        window.viewer3D.switchTo2DView();
                        // Update view mode button states
                        const view2DBtn = document.getElementById('view2D');
                        const view3DBtn = document.getElementById('view3D');
                        if (view2DBtn && view3DBtn) {
                            view2DBtn.classList.add('btn-success');
                            view2DBtn.classList.remove('btn-secondary');
                            view3DBtn.classList.remove('btn-success');
                            view3DBtn.classList.add('btn-secondary');
                        }
                    }
                    window.viewer3D.setView('left');
                }
                // Change 2D wire routing projection
                if (window.wireRouting3D) {
                    window.wireRouting3D.setView('side-left');
                }
                updateViewButtons('side-left');
            });
            
            // Set default active view
            updateViewButtons('top');
            
            // Initialize toggle button states
            const gridBtn = document.getElementById('toggle-wire-grid');
            const portsBtn = document.getElementById('toggle-wire-ports');
            if (gridBtn) {
                gridBtn.textContent = '‚äû Grid ON';
                gridBtn.style.background = '#27ae60';
            }
            if (portsBtn) {
                portsBtn.textContent = 'üìç Ports ON';
                portsBtn.style.background = '#27ae60';
            }
            
            // Handle window resize to keep canvas sized correctly
            window.addEventListener('resize', () => {
                if (window.wireRouting3D && window.wireRouting3D.enabled) {
                    const canvas = document.getElementById('wire-routing-overlay');
                    const container = document.getElementById('model-viewer-container');
                    if (canvas && container) {
                        canvas.width = container.clientWidth;
                        canvas.height = container.clientHeight;
                    }
                }
            });
            
            // Port radius selector - affects BOTH 2D canvas display AND 3D sphere size
            document.getElementById('wire-port-radius')?.addEventListener('change', (e) => {
                const pixelValue = parseInt(e.target.value);
                
                // Update 2D canvas port display radius
                window.wireRouting3D?.setPortRadius(pixelValue);
                
                // Update 3D port sphere size (map pixel values to scale multipliers)
                if (window.viewer3D) {
                    // Map: 4px=0.5x, 6px=1.0x, 8px=1.5x, 10px=2.0x
                    const scaleMap = {
                        4: 0.67,
                        6: 1.0,
                        8: 1.33,
                        10: 1.67
                    };
                    const scale = scaleMap[pixelValue] || 1.0;
                    window.viewer3D.setPortVisualScale(scale);
                }
            });
            
            // Toggle buttons with visual feedback
            document.getElementById('toggle-wire-ports')?.addEventListener('click', (e) => {
                window.wireRouting3D?.togglePorts();
                const btn = e.target;
                const isOn = window.wireRouting3D?.showPorts;
                btn.textContent = isOn ? 'üìç Ports ON' : 'üìç Ports OFF';
                btn.style.background = isOn ? '#27ae60' : '#34495e';
            });
            
            document.getElementById('reset-wire-view')?.addEventListener('click', () => {
                window.wireRouting3D?.resetView();
            });
            
            // Check status button
            document.getElementById('check-wire-status')?.addEventListener('click', () => {
                if (!window.wireRouting3D) {
                    alert('‚ùå Wire routing system not initialized!\n\nPlease switch to 3D Models view first.');
                    return;
                }
                
                const portCount = window.wireRouting3D.portsManager ? 
                    window.wireRouting3D.portsManager.getAllPortsWithWorldPositions().length : 0;
                const wireCount = window.wireRouting3D.wireRouter ? 
                    window.wireRouting3D.wireRouter.wires.length : 0;
                
                let message = 'üîç Wire Routing System Status:\n\n';
                message += `‚úÖ System: ${window.wireRouting3D.enabled ? 'ENABLED' : 'DISABLED'}\n`;
                message += `üìç Ports: ${portCount} available\n`;
                message += `üîå Wires: ${wireCount} created\n`;
                message += `üëÅÔ∏è Show Ports: ${window.wireRouting3D.showPorts ? 'ON' : 'OFF'}\n`;
                message += `‚äû Show Grid: ${window.wireRouting3D.showGrid ? 'ON' : 'OFF'}\n`;
                message += `üìê View: ${window.wireRouting3D.viewManager.currentView}\n`;
                message += `üé® Canvas: ${window.wireRouting3D.canvas.width}x${window.wireRouting3D.canvas.height}\n`;
                message += `üìè Scale: ${window.wireRouting3D.scale.toFixed(2)}\n\n`;
                
                if (portCount === 0) {
                    message += '‚ö†Ô∏è NO PORTS FOUND!\n\n';
                    message += 'To add ports:\n';
                    message += '1. Load a model\n';
                    message += '2. Enable "Edit Ports Mode"\n';
                    message += '3. Click on model to add ports\n';
                } else {
                    message += '‚úÖ Ready to wire!\n';
                    message += 'Click on ports to start routing.';
                }
                
                alert(message);
                console.log('üìä System Status:', {
                    enabled: window.wireRouting3D.enabled,
                    ports: portCount,
                    wires: wireCount,
                    showPorts: window.wireRouting3D.showPorts,
                    showGrid: window.wireRouting3D.showGrid,
                    view: window.wireRouting3D.viewManager.currentView
                });
            });
            
            // Clear all wires
            document.getElementById('clear-all-2d-wires')?.addEventListener('click', () => {
                if (window.viewer3D && window.viewer3D.wiring3DManager && confirm('Clear all wires?')) {
                    window.viewer3D.wiring3DManager.clearAllWires(window.viewer3D);
                }
            });
            
            // Auto-connect settings
            document.getElementById('wire-auto-connect-enabled')?.addEventListener('change', (e) => {
                if (window.viewer3D && window.viewer3D.wiring3DManager) {
                    window.viewer3D.wiring3DManager.autoConnectEnabled = e.target.checked;
                    console.log('üîó Auto-connect:', e.target.checked ? 'ENABLED' : 'DISABLED');
                    
                    // Show/hide distance slider
                    const container = document.getElementById('auto-connect-distance-container');
                    if (container) {
                        container.style.display = e.target.checked ? 'block' : 'none';
                    }
                }
            });
            
            document.getElementById('wire-auto-connect-distance')?.addEventListener('input', (e) => {
                const distance = parseInt(e.target.value);
                document.getElementById('auto-connect-distance-value').textContent = distance;
                
                if (window.viewer3D && window.viewer3D.wiring3DManager) {
                    window.viewer3D.wiring3DManager.autoConnectDistance = distance;
                    console.log(`üîó Auto-connect distance: ${distance}mm`);
                }
            });
        }
        
        // Initialize 3D viewer when needed
        document.addEventListener('DOMContentLoaded', function() {
            // 3D viewer will be initialized by viewSwitching.js when switching to 3D view
            window.init3DModelViewer = function() {
                init3DViewer();
                loadModelButtons();
                setupCustomModelUpload();
                setupPortVisibilityToggle();
                // setupWireSystem(); // OLD SYSTEM REMOVED
                setup2DWireRoutingControls(); // New 2D wire routing controls
            };
        });
        
        // Port Config Viewer code has been moved to js/port/ folder
        // See: portConfigScene.js, portConfigLoader.js, portConfigMarkers.js,
        //      portConfigUI.js, portConfigStorage.js, portConfigInteraction.js,
        //      portConfigViewer.js, and portConfigInit.js
    </script>
</body>
</html>

