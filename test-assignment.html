<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assignment & Interaction Test</title>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; background: #1e1e1e; color: white; }
        #container { display: flex; height: 100vh; }
        #viewport { flex: 1; position: relative; }
        #sidebar { width: 300px; background: #2c3e50; padding: 20px; overflow-y: auto; }
        .btn { padding: 10px 15px; margin: 5px 0; width: 100%; cursor: pointer; background: #3498db; color: white; border: none; border-radius: 4px; }
        .btn:hover { background: #2980b9; }
        .btn-success { background: #27ae60; }
        .btn-danger { background: #e74c3c; }
        .section { margin: 20px 0; padding: 15px; background: #34495e; border-radius: 4px; }
        .section h3 { margin-top: 0; }
        #log { max-height: 200px; overflow-y: auto; font-size: 12px; background: #000; padding: 10px; border-radius: 4px; margin-top: 10px; }
        .log-entry { padding: 2px 0; border-bottom: 1px solid #333; }
        .info { background: rgba(52, 152, 219, 0.8); padding: 10px; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
    <div id="container">
        <div id="viewport"></div>
        <div id="sidebar">
            <h2>üß™ Test Suite</h2>
            
            <div class="section">
                <h3>1. Add Components</h3>
                <button class="btn btn-success" onclick="addButton()">+ Add Button</button>
                <button class="btn btn-success" onclick="addMotor()">+ Add Motor</button>
                <button class="btn btn-success" onclick="addLED()">+ Add LED</button>
            </div>
            
            <div class="section">
                <h3>2. Test Interactions</h3>
                <div class="info">Try:
                    <br>‚Ä¢ Click components
                    <br>‚Ä¢ Hover (tooltip)
                    <br>‚Ä¢ Long-press (hold >1s)
                </div>
            </div>
            
            <div class="section">
                <h3>3. Assignment</h3>
                <button class="btn" onclick="assignLast()">üìå Assign Last Component</button>
                <button class="btn" onclick="showStats()">üìä Show Statistics</button>
                <button class="btn btn-danger" onclick="clearAll()">üóëÔ∏è Clear All</button>
            </div>
            
            <div class="section">
                <h3>üìã Component Log</h3>
                <div id="log"></div>
            </div>
            
            <div class="section">
                <h3>üìä Stats</h3>
                <div id="stats">-</div>
            </div>
        </div>
    </div>

    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/TransformControls.js"></script>

    <!-- Our System -->
    <script src="js/model/config.js"></script>
    <script src="js/shared/assignment.js"></script>
    <script src="js/model/interaction.js"></script>
    <script src="js/model/mounting.js"></script>
    <script src="js/model/components/plc.js"></script>
    <script src="js/model/components/wire.js"></script>
    <script src="js/model/components/button.js"></script>
    <script src="js/model/components/motor.js"></script>
    <script src="js/model/components/led.js"></script>
    <script src="js/model/scene.js"></script>

    <script>
        let scene;
        let components = [];
        
        // Log function
        function log(message, color = 'white') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.style.color = color;
            entry.textContent = new Date().toLocaleTimeString() + ' - ' + message;
            logDiv.insertBefore(entry, logDiv.firstChild);
            console.log(message);
        }
        
        // Initialize
        window.addEventListener('DOMContentLoaded', function() {
            log('Initializing 3D scene...', '#3498db');
            scene = new ModelScene('viewport');
            
            // Add base plate
            scene.addMountingSurface('plate', { width: 600, length: 400, thickness: 2 });
            log('‚úÖ Scene initialized', '#27ae60');
            
            // Listen to interaction events
            if (scene.interactionManager) {
                log('‚úÖ Interaction Manager active', '#27ae60');
                
                // Override click handler to log
                const originalOnClick = scene.interactionManager.onClick.bind(scene.interactionManager);
                scene.interactionManager.onClick = function(component, event) {
                    log('üñ±Ô∏è Clicked: ' + (component.name || component.type), '#3498db');
                    originalOnClick(component, event);
                };
            }
            
            // Listen to assignment events
            if (typeof assignmentManager !== 'undefined') {
                log('‚úÖ Assignment Manager active', '#27ae60');
                
                assignmentManager.on('assigned', (detail) => {
                    log('üìå Assigned: ' + detail.component3D.name + ' ‚Üí ' + detail.ladderAddress, '#27ae60');
                    updateStats();
                });
                
                assignmentManager.on('unassigned', (detail) => {
                    log('‚ùå Unassigned: ' + detail.component3D.name, '#e67e22');
                    updateStats();
                });
            }
            
            updateStats();
        });
        
        // Add components
        function addButton() {
            const btn = scene.addFieldDevice('button', {
                x: Math.random() * 200 - 100,
                y: 50,
                z: Math.random() * 200 - 100
            }, { color: 0xff0000 });
            components.push(btn);
            log('‚ûï Added Button: ' + btn.id, '#2ecc71');
            updateStats();
        }
        
        function addMotor() {
            const motor = scene.addFieldDevice('motor', {
                x: Math.random() * 200 - 100,
                y: 50,
                z: Math.random() * 200 - 100
            }, { power: 1500 });
            components.push(motor);
            log('‚ûï Added Motor: ' + motor.id, '#2ecc71');
            updateStats();
        }
        
        function addLED() {
            const led = scene.addFieldDevice('led', {
                x: Math.random() * 200 - 100,
                y: 50,
                z: Math.random() * 200 - 100
            }, { color: 'green' });
            components.push(led);
            log('‚ûï Added LED: ' + led.id, '#2ecc71');
            updateStats();
        }
        
        // Assignment
        function assignLast() {
            if (components.length === 0) {
                alert('Add a component first!');
                return;
            }
            
            const comp = components[components.length - 1];
            const address = comp.type === 'button' ? 'I0.' + components.length : 'Q0.' + components.length;
            
            if (assignmentManager.assign(comp, address)) {
                log('‚úÖ Assigned ' + comp.type + ' to ' + address, '#27ae60');
            } else {
                log('‚ùå Failed to assign', '#e74c3c');
            }
        }
        
        // Stats
        function updateStats() {
            if (typeof assignmentManager === 'undefined') return;
            
            const stats = assignmentManager.getStats();
            const unassigned = assignmentManager.getUnassignedCount();
            
            document.getElementById('stats').innerHTML = `
                <strong>Components:</strong> ${components.length}<br>
                <strong style="color: #27ae60;">‚úÖ Assigned:</strong> ${stats.totalAssignments}<br>
                <strong style="color: #e67e22;">‚ö†Ô∏è Unassigned:</strong> ${unassigned.components3D}
            `;
        }
        
        function showStats() {
            updateStats();
            const stats = assignmentManager.getStats();
            alert(JSON.stringify(stats, null, 2));
        }
        
        function clearAll() {
            if (confirm('Clear all components and assignments?')) {
                components = [];
                assignmentManager.clear();
                scene.fieldDevices = [];
                // Reload page to clear scene
                location.reload();
            }
        }
    </script>
</body>
</html>
